@page "/ems"

@using System
@using System.Collections.Generic
@using System.Linq
@using Microsoft.AspNetCore.Components
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.AspNetCore.Components.Web
@using Microsoft.JSInterop
@using ChangeEventArgs = Microsoft.AspNetCore.Components.ChangeEventArgs

@inject IJSRuntime JSRuntime

@* === START: MODIFIED UI BASED ON FEEDBACK === *@

@* 1. Main Header (Simulating the blue bar from the PDF) - Arabic text removed *@
<div class="container-fluid p-3 mb-3" style="background-color: #004a99; color: white;">
    <div class="d-flex justify-content-start align-items-center">
        <h2 class="m-0">EMS - Enquiry Management System</h2>
    </div>
</div>

@* 2. Main Module Navigation (Simulating the grey bar from the PDF) *@
<ul class="nav nav-pills mb-3 px-3">
    <li class="nav-item">
        <button class="nav-link active" aria-current="page">Enquiry</button>
    </li>
    <li class="nav-item">
        <button class="nav-link disabled" disabled>Pricing</button>
    </li>
    <li class="nav-item">
        <button class="nav-link disabled" disabled>Quote</button>
    </li>
    <li class="nav-item">
        <button class="nav-link disabled" disabled>Probability</button>
    </li>
    <li class="nav-item">
        <button class="nav-link disabled" disabled>Reports</button>
    </li>
    <li class="nav-item">
        <button class="nav-link disabled" disabled>Dashboard</button>
    </li>
</ul>

@* 3. Wrapper for the existing content *@
<div class="container-fluid px-3">

    @* === END: NEW UI BASED ON PDF === *@

    <ul class="nav nav-tabs">
        <li class="nav-item">
            <button class="@GetTabClass("New")" @onclick="OnClickTabNew">New Enquiry</button>
        </li>
        <li class="nav-item">
            <button class="@GetTabClass("Modify")" @onclick="OnClickTabModify">Modify Enquiry</button>
        </li>
        <li class="nav-item">
            <button class="@GetTabClass("Search")" @onclick="OnClickTabSearch">Search Enquiry</button>
        </li>
    </ul>
    <br />

    @* ---------------- NEW ENQUIRY ---------------- *@
    @if (activeTab == "New")
    {
        <EditForm Model="@enquiryModel" OnValidSubmit="@HandleMainFormSubmit">
            <div class="row mb-2">
                <div class="col-md-3">
                    <label class="form-label" style="font-size: 13px;">Source of Enquiry<span class="text-danger">*</span></label>
                    <InputSelect class="form-select" @bind-Value="enquiryModel.SourceOfInfo" style="font-size: 13px;" @onchange="@(() => ClearValidationError("SourceOfInfo"))">
                        <option value="">-- Select Source --</option>
                        @foreach (var source in sourceOfInfos)
                        {
                            <option value="@source">@source</option>
                        }
                    </InputSelect>
                    @if (inputErrors.ContainsKey("SourceOfInfo"))
                    {
                        <div class="text-danger" style="font-size: 11px;">@inputErrors["SourceOfInfo"]</div>
                    }
                </div>
            </div>

            <div class="row mb-2">
                <div class="col-md-1">
                    <label class="form-label" style="font-size: 13px;"> Enquiry Date <span class="text-danger">*</span></label>
                    <InputDate class="form-control" @bind-Value="enquiryModel.EnquiryDate" style="font-size: 13px;" @oninput="@(() => ClearValidationError("EnquiryDate"))" />
                    @if (inputErrors.ContainsKey("EnquiryDate"))
                    {
                        <div class="text-danger" style="font-size: 11px;">@inputErrors["EnquiryDate"]</div>
                    }
                </div>
                <div class="col-md-1">
                    <label class="form-label" style="font-size: 13px;">Due Date<span class="text-danger">*</span></label>
                    <InputDate class="form-control" @bind-Value="enquiryModel.DueOn" style="font-size: 13px;" @oninput="@(() => ClearValidationError("DueOn"))" />
                    @if (inputErrors.ContainsKey("DueOn"))
                    {
                        <div class="text-danger" style="font-size: 11px;">@inputErrors["DueOn"]</div>
                    }
                </div>
                <div class="col-md-1">
                    <label class="form-label" style="font-size: 13px;">Site visit date (If applicable)</label>
                    <InputDate class="form-control" @bind-Value="enquiryModel.SiteVisitDate" style="font-size: 13px;" />
                </div>
            </div>

            <div class="row mb-2">
                <div class="col-md-3">
                    <label class="form-label" style="font-size: 13px;">Enquiry Type<span class="text-danger">*</span></label>
                    <InputSelect class="form-select" @bind-Value="selectedenqtype" style="font-size: 13px;">
                        <option value="">-- Select type --</option>
                        @foreach (var et in enquirytype)
                        {
                            <option value="@et">@et</option>
                        }
                    </InputSelect>
                    <div class="d-flex align-items-center mt-1">
                        <select class="form-select" multiple style="height: 75px; font-size: 13px;" @onchange="HandleEnqTypeListBoxSelection">
                            @foreach (var item in enqtypelistbox)
                            {
                                <option value="@item">@item</option>
                            }
                        </select>
                        <div class="d-flex flex-column ms-1">
                            <button type="button" class="btn btn-outline-success mb-1" style="width: 36px; padding: 0.25rem 0.5rem;" @onclick="AddToListBoxenqtype">+</button>
                            <button type="button" class="btn btn-outline-danger" style="width: 36px; padding: 0.25rem 0.5rem;" @onclick="RemoveFromListBoxenqtype">-</button>
                        </div>
                    </div>
                    @if (inputErrors.ContainsKey("Enquirytype"))
                    {
                        <div class="text-danger" style="font-size: 11px;">@inputErrors["Enquirytype"]</div>
                    }
                </div>
            </div>

            <div class="row mb-2">
                <div class="col-md-3">
                    <label class="form-label" style="font-size: 13px;">Enquiry for<span class="text-danger">*</span></label>
                    <div class="input-group">
                        <InputText id="enquiryForInput" class="form-control" @bind-Value="selectedenqfor" style="font-size: 13px;"
                                   list="enquiryForList"
                                   @onblur="OnEnquiryForBlur" />
                        <datalist id="enquiryForList">
                            @foreach (var item in enquiryfor)
                            {
                                <option value="@item"></option>
                            }
                        </datalist>
                        <button type="button" class="btn" style="font-size: 12px; padding: 0.25rem 0.5rem; background-color: #f0f0f0; color: black; border-color: #ccc;" @onclick="ToggleNewEnquiryForModal">New</button>
                        <button type="button" class="btn" style="font-size: 12px; padding: 0.25rem 0.5rem; background-color: #f0f0f0; color: black; border-color: #ccc;"
                                @onclick="StartEditEnquiryFor" disabled="@(string.IsNullOrWhiteSpace(selectedenqfor))">
                            Edit
                        </button>
                    </div>
                    @if (inputErrors.ContainsKey("Enquiryfor") && inputErrors["Enquiryfor"] == NO_DATA_FOUND)
                    {
                        <div class="text-danger" style="font-size: 11px;">@inputErrors["Enquiryfor"]</div>
                    }
                    <div class="d-flex align-items-center mt-1">
                        <select class="form-select" multiple style="height: 75px; font-size: 13px;" @onchange="HandleEnqForListBoxSelection">
                            @foreach (var item in enqforlistbox)
                            {
                                <option value="@item">@item</option>
                            }
                        </select>
                        <div class="d-flex flex-column ms-1">
                            <button type="button" class="btn btn-outline-success mb-1" style="width: 36px; padding: 0.25rem 0.5rem;" @onclick="AddToListBoxenqfor">+</button>
                            <button type="button" class="btn btn-outline-danger" style="width: 36px; padding: 0.25rem 0.5rem;" @onclick="RemoveFromListBoxenqfor">-</button>
                        </div>
                    </div>
                    @if (inputErrors.ContainsKey("Enquiryfor") && inputErrors["Enquiryfor"] != NO_DATA_FOUND)
                    {
                        <div class="text-danger" style="font-size: 11px;">@inputErrors["Enquiryfor"]</div>
                    }
                </div>
            </div>

            @* === FIX 1: Changed Customer Name to Listbox === *@
            <div class="row mb-2">
                <div class="col-md-3">
                    <label class="form-label" style="font-size: 13px;">Customer Name (Company Name)<span class="text-danger">*</span></label>
                    <div class="input-group">
                        <InputSelect class="form-select" @bind-Value="selectedCustomerInput" style="font-size: 13px;">
                            <option value="">-- Select Customer Company --</option>
                            @foreach (var c in existingCustomers)
                            {
                                <option value="@c">@c</option>
                            }
                        </InputSelect>
                        <button type="button" class="btn" style="font-size: 12px; padding: 0.25rem 0.5rem; background-color: #f0f0f0; color: black; border-color: #ccc;" @onclick="ToggleNewCustomerInput">New</button>
                        <button type="button" class="btn" style="font-size: 12px; padding: 0.25rem 0.5rem; background-color: #f0f0f0; color: black; border-color: #ccc;" @onclick="StartEditCompany" disabled="@(string.IsNullOrWhiteSpace(selectedCustomerInput))">Edit</button>
                    </div>
                    @if (inputErrors.ContainsKey("CustomerName"))
                    {
                        <div class="text-danger" style="font-size: 11px;">@inputErrors["CustomerName"]</div>
                    }
                    <div class="d-flex align-items-center mt-1">
                        <select class="form-select" multiple style="height: 70px; font-size: 13px;" @onchange="HandleCustomerListBoxSelection">
                            @* === FIX 2: Numbered Listbox === *@
                            @foreach (var item in customerListBox.Select((name, index) => new { Name = name, Index = index + 1 }))
                            {
                                <option value="@item.Name">@item.Index. @item.Name</option>
                            }
                        </select>
                        <div class="d-flex flex-column ms-1">
                            <button type="button" class="btn btn-outline-success mb-1" style="width: 36px; padding: 0.25rem 0.5rem;" @onclick="AddCustomerToListBox" disabled="@(string.IsNullOrWhiteSpace(selectedCustomerInput))">+</button>
                            <button type="button" class="btn btn-outline-danger" style="width: 36px; padding: 0.25rem 0.5rem;" @onclick="RemoveCustomerFromListBox" disabled="@(selectedCustomerListboxItems.Count == 0)">-</button>
                        </div>
                    </div>
                </div>

                <div class="col-md-3">
                    <label class="form-label" style="font-size: 13px;">Received From (Contact Person)<span class="text-danger">*</span></label>
                    <div class="input-group">
                        @* === FIX 1: Removed disabled property === *@
                        @* === FIX 3: Dropdown is now filtered by customerListBox === *@
                        <InputSelect id="receivedContactSelect" class="form-select" @bind-Value="selectedReceivedContact" style="font-size: 13px;">
                            <option value="">-- Select Contact --</option>
                            @* === FIX 1: No longer filtering based on a single customer === *@
                            @foreach (var contact in filteredReceivedFroms)
                            {
                                var fullString = $"{contact.ContactName}{CONTACT_DELIMITER}{contact.CompanyName}";
                                <option value="@fullString">@contact.ContactName (@contact.CompanyName)</option>
                            }
                        </InputSelect>
                        <button type="button" class="btn" style="font-size: 12px; padding: 0.25rem 0.5rem; background-color: #f0f0f0; color: black; border-color: #ccc;" @onclick="ToggleNewReceivedFromInput">New</button>
                        <button type="button" class="btn" style="font-size: 12px; padding: 0.25rem 0.5rem; background-color: #f0f0f0; color: black; border-color: #ccc;"
                                @onclick="StartEditContact" disabled="@(!HasAnyContactSelection)">
                            Edit
                        </button>
                    </div>
                    @if (inputErrors.ContainsKey("ReceivedFrom"))
                    {
                        <div class="text-danger" style="font-size: 11px;">@inputErrors["ReceivedFrom"]</div>
                    }
                    <div class="d-flex align-items-center mt-1">
                        <select class="form-select" multiple style="height: 70px; font-size: 13px;" @onchange="HandleReceivedFromListBoxSelection">
                            @* === FIX 2: Numbered Listbox (Grouped by Customer) === *@
                            @foreach (var fullString in receivedContactListBox)
                            {
                                var parts = fullString.Split(CONTACT_DELIMITER);
                                if (parts.Length < 2) continue; // Safety check
                                var contactName = parts[0];
                                var companyName = parts[1];

                                int companyIndex = customerListBox.IndexOf(companyName) + 1;
                                string prefix = companyIndex > 0 ? $"{companyIndex}." : "-."; // Use index or a fallback

                                <option value="@fullString">@prefix @contactName (@companyName)</option>
                            }
                        </select>
                        <div class="d-flex flex-column ms-1">
                            <button type="button" class="btn btn-outline-success mb-1" style="width: 36px; padding: 0.25rem 0.5rem;" @onclick="AddSelectedContactToListBox" disabled="@(string.IsNullOrWhiteSpace(selectedReceivedContact))">+</button>
                            <button type="button" class="btn btn-outline-danger" style="width: 36px; padding: 0.25rem 0.5rem;" @onclick="RemoveSelectedContactFromListBox" disabled="@(selectedReceivedFromListboxItems.Count == 0)">-</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row mb-2">
                <div class="col-md-3">
                    <label class="form-label" style="font-size: 13px;">Project Name<span class="text-danger">*</span></label>
                    <InputText id="projectNameInput" class="form-control" @bind-Value="enquiryModel.ProjectName" style="font-size: 13px;"
                               list="projectNameList"
                               @oninput="@(() => ClearValidationError("ProjectName"))" />
                    <datalist id="projectNameList">
                        @foreach (var client in projectNames)
                        {
                            <option value="@client"></option>
                        }
                    </datalist>
                    @if (inputErrors.ContainsKey("ProjectName"))
                    {
                        <div class="text-danger" style="font-size: 11px;">@inputErrors["ProjectName"]</div>
                    }
                </div>
            </div>

            <div class="row mb-2">
                <div class="col-md-3">
                    <label class="form-label" style="font-size: 13px;">Client Name<span class="text-danger">*</span></label>
                    <div class="input-group">
                        <InputText id="clientNameInput" class="form-control" @bind-Value="enquiryModel.ClientName" style="font-size: 13px;"
                                   list="clientNameList"
                                   @onblur="OnClientNameBlur"
                                   @oninput="@(() => ClearValidationError("ClientName"))" />
                        <datalist id="clientNameList">
                            @foreach (var client in clientNames)
                            {
                                <option value="@client"></option>
                            }
                        </datalist>
                        <button type="button" class="btn" style="font-size: 12px; padding: 0.25rem 0.5rem; background-color: #f0f0f0; color: black; border-color: #ccc;" @onclick="ToggleNewCustomerInput">New</button>
                        <button type="button" class="btn" style="font-size: 12px; padding: 0.25rem 0.5rem; background-color: #f0f0f0; color: black; border-color: #ccc;" @onclick="StartEditCompany" disabled="@(string.IsNullOrWhiteSpace(enquiryModel.ClientName))">Edit</button>
                    </div>
                    @if (inputErrors.ContainsKey("ClientName"))
                    {
                        <div class="text-danger" style="font-size: 11px;">@inputErrors["ClientName"]</div>
                    }
                </div>
            </div>

            <div class="row mb-2">
                <div class="col-md-3">
                    <label class="form-label" style="font-size: 13px;">Consultant Name</label>
                    <div class="input-group">
                        <InputText id="consultantNameInput" class="form-control" @bind-Value="enquiryModel.ConsultantName" style="font-size: 13px;"
                                   list="consultantNameList"
                                   @onblur="OnConsultantNameBlur" />
                        <datalist id="consultantNameList">
                            @foreach (var consultant in consultantNames)
                            {
                                <option value="@consultant"></option>
                            }
                        </datalist>
                        <button type="button" class="btn" style="font-size: 12px; padding: 0.25rem 0.5rem; background-color: #f0f0f0; color: black; border-color: #ccc;" @onclick="ToggleNewCustomerInput">New</button>
                        <button type="button" class="btn" style="font-size: 12px; padding: 0.25rem 0.5rem; background-color: #f0f0f0; color: black; border-color: #ccc;" @onclick="StartEditCompany" disabled="@(string.IsNullOrWhiteSpace(enquiryModel.ConsultantName))">Edit</button>
                    </div>
                    @if (inputErrors.ContainsKey("ConsultantName"))
                    {
                        <div class="text-danger" style="font-size: 11px;">@inputErrors["ConsultantName"]</div>
                    }
                </div>
            </div>

            <div class="row mb-2">
                <div class="col-md-3">
                    <label class="form-label" style="font-size: 13px;">Concerned SE<span class="text-danger">*</span></label>
                    <div class="input-group">
                        <InputText id="concernedSEInput" class="form-control" @bind-Value="selectedSE" style="font-size: 13px;"
                                   list="concernedSEList"
                                   @onblur="OnConcernedSEBlur" />
                        <datalist id="concernedSEList">
                            @foreach (var se in concernedSEs)
                            {
                                <option value="@se"></option>
                            }
                        </datalist>
                        <button type="button" class="btn" style="font-size: 12px; padding: 0.25rem 0.5rem; background-color: #f0f0f0; color: black; border-color: #ccc;" @onclick="ToggleNewUserModal">New</button>
                        <button type="button" class="btn" style="font-size: 12px; padding: 0.25rem 0.5rem; background-color: #f0f0f0; color: black; border-color: #ccc;"
                                @onclick="StartEditUser" disabled="@(string.IsNullOrWhiteSpace(selectedSE))">
                            Edit
                        </button>
                    </div>
                    @if (inputErrors.ContainsKey("ConcernedSE"))
                    {
                        <div class="text-danger" style="font-size: 11px;">@inputErrors["ConcernedSE"]</div>
                    }
                    <div class="d-flex align-items-center mt-1">
                        <select class="form-select" multiple style="height: 70px; font-size: 13px;" @onchange="HandleSEListBoxSelection">
                            @foreach (var se in seListBox)
                            {
                                <option value="@se">@se</option>
                            }
                        </select>
                        <div class="d-flex flex-column ms-1">
                            <button type="button" class="btn btn-outline-success mb-1" style="width: 36px; padding: 0.25rem 0.5rem;" @onclick="AddSEToListBoxToselectedSE">+</button>
                            <button type="button" class="btn btn-outline-danger" style="width: 36px; padding: 0.25rem 0.5rem;" @onclick="RemoveSEFromListBoxselectedSE">-</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row mb-3">
                <div class="col-md-3">
                    <label class="form-label" style="font-size: 13px;">Enquiry details<span class="text-danger">*</span></label>
                    <InputTextArea class="form-control" @bind-Value="enquiryModel.DetailsOfEnquiry"
                                   @oninput="@(() => ClearValidationError("DetailsOfEnquiry"))"
                                   @onkeydown="HandleTextAreaKeyPress" />
                    @if (inputErrors.ContainsKey("DetailsOfEnquiry"))
                    {
                        <div class="text-danger" style="font-size: 11px;">@inputErrors["DetailsOfEnquiry"]</div>
                    }
                </div>
            </div>

            <div class="row mb-2">
                <div class="col-md-3">
                    <label class="form-label" style="font-size: 13px;">Document received along with the enquiry</label>
                    <div class="d-flex flex-wrap gap-2 mb-2" style="font-size: 13px;">
                        <div class="form-check form-check-inline">
                            <InputCheckbox class="form-check-input" @bind-Value="enquiryModel.hardcopy" id="hardcopyCheck" />
                            <label class="form-check-label" for="hardcopyCheck">Hard Copies</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <InputCheckbox class="form-check-input" @bind-Value="enquiryModel.drawing" id="drawingCheck" />
                            <label class="form-check-label" for="drawingCheck">Drawings</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <InputCheckbox class="form-check-input" @bind-Value="enquiryModel.dvd" id="dvdCheck" />
                            <label class="form-check-label" for="dvdCheck">CD/DVD</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <InputCheckbox class="form-check-input" @bind-Value="enquiryModel.spec" id="specCheck" />
                            <label class="form-check-label" for="specCheck">Specification</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <InputCheckbox class="form-check-input" @bind-Value="enquiryModel.eqpschedule" id="eqpscheduleCheck" />
                            <label class="form-check-label" for="eqpscheduleCheck">Equipment Schedule</label>
                        </div>
                    </div>
                    <label class="form-label" style="font-size: 13px;">Others Specify</label>
                    <InputTextArea class="form-control" @bind-Value="enquiryModel.DocumentsReceived" @onkeydown="HandleTextAreaKeyPress" />
                </div>
            </div>

            <div class="row mb-2">
                <div class="col-md-3">
                    <label class="form-label" style="font-size: 13px;">Remarks</label>
                    <InputTextArea class="form-control" @bind-Value="enquiryModel.Remark" @onkeydown="HandleTextAreaKeyPress" />
                </div>
            </div>
            <div class="row mb-2">
                <div class="col-md-3">
                    <div class="form-check" style="font-size: 13px;">
                        <InputCheckbox class="form-check-input" @bind-Value="enquiryModel.AutoAck" id="autoAckCheck" />
                        <label class="form-check-label" for="autoAckCheck">Is it necessary to send an acknowledgement mail to the customer ?</label>
                    </div>
                    <div class="form-check" style="font-size: 13px;">
                        <InputCheckbox class="form-check-input" @bind-Value="enquiryModel.ceosign" id="ceoSignCheck" />
                        <label class="form-check-label" for="ceoSignCheck">Is ED/CEO Signature required ? </label>
                    </div>
                </div>
            </div>

            <div class="row mt-4 mb-4" style="padding-bottom: 100px;">
                <div class="col-12">
                    <button type="submit" class="btn btn-outline-success me-2"><i class="bi bi-plus-circle"></i> Add</button>
                    <button type="button" class="btn btn-outline-danger me-2" @onclick="ResetFormState"><i class="bi bi-x-circle"></i> Cancel</button>
                </div>
            </div>
        </EditForm>
    }

    @* ---------------- MODIFY ENQUIRY ---------------- *@
    @if (activeTab == "Modify")
    {
        <div class="row mb-3">
            <div class="col-md-3">
                <label class="form-label" style="font-size:13px;">Request No<span class="text-danger">*</span></label>
                <InputText class="form-control" @bind-Value="modifyRequestNo" placeholder="e.g. EYS/2025/11/001" />
            </div>
            <div class="col-md-3 d-flex align-items-end">
                <button class="btn btn-outline-primary me-2" @onclick="LoadForModify">Load</button>
                <button class="btn btn-outline-secondary" @onclick="ClearModify">Clear</button>
            </div>
        </div>

        @if (modifyLoadedSnapshot is not null)
        {
            <div class="alert alert-info py-2" style="font-size:13px;">
                Loaded <strong>@modifyRequestNo</strong>. You can edit below and click <em>Save Changes</em>.
            </div>

            <EditForm Model="@enquiryModel" OnValidSubmit="@HandleModifyFormSubmit">
                @* --- START: Full Form Structure for Modify --- *@

                <div class="row mb-2">
                    <div class="col-md-3">
                        <label class="form-label" style="font-size: 13px;">Status<span class="text-danger">*</span></label>
                        @* === FIX 3: Updated list === *@
                        <InputSelect class="form-select" @bind-Value="enquiryModel.Status" style="font-size: 13px;" @onchange="@(() => ClearValidationError("Status"))">
                            @foreach (var status in allStatuses)
                            {
                                <option value="@status">@status</option>
                            }
                        </InputSelect>
                        @if (inputErrors.ContainsKey("Status"))
                        {
                            <div class="text-danger" style="font-size: 11px;">@inputErrors["Status"]</div>
                        }
                    </div>
                </div>

                <div class="row mb-2">
                    <div class="col-md-3">
                        <label class="form-label" style="font-size: 13px;">Source of Enquiry<span class="text-danger">*</span></label>
                        <InputSelect class="form-select" @bind-Value="enquiryModel.SourceOfInfo" style="font-size: 13px;" @onchange="@(() => ClearValidationError("SourceOfInfo"))">
                            <option value="">-- Select Source --</option>
                            @foreach (var source in sourceOfInfos)
                            {
                                <option value="@source">@source</option>
                            }
                        </InputSelect>
                        @if (inputErrors.ContainsKey("SourceOfInfo"))
                        {
                            <div class="text-danger" style="font-size: 11px;">@inputErrors["SourceOfInfo"]</div>
                        }
                    </div>
                </div>

                <div class="row mb-2">
                    <div class="col-md-1">
                        <label class="form-label" style="font-size: 13px;"> Enquiry Date <span class="text-danger">*</span></label>
                        <InputDate class="form-control" @bind-Value="enquiryModel.EnquiryDate" style="font-size: 13px;" @oninput="@(() => ClearValidationError("EnquiryDate"))" />
                        @if (inputErrors.ContainsKey("EnquiryDate"))
                        {
                            <div class="text-danger" style="font-size: 11px;">@inputErrors["EnquiryDate"]</div>
                        }
                    </div>
                    <div class="col-md-1">
                        <label class="form-label" style="font-size: 13px;">Due Date<span class="text-danger">*</span></label>
                        <InputDate class="form-control" @bind-Value="enquiryModel.DueOn" style="font-size: 13px;" @oninput="@(() => ClearValidationError("DueOn"))" />
                        @if (inputErrors.ContainsKey("DueOn"))
                        {
                            <div class="text-danger" style="font-size: 11px;">@inputErrors["DueOn"]</div>
                        }
                    </div>
                    <div class="col-md-1">
                        <label class="form-label" style="font-size: 13px;">Site visit date (If applicable)</label>
                        <InputDate class="form-control" @bind-Value="enquiryModel.SiteVisitDate" style="font-size: 13px;" />
                    </div>
                </div>

                <div class="row mb-2">
                    <div class="col-md-3">
                        <label class="form-label" style="font-size: 13px;">Enquiry Type<span class="text-danger">*</span></label>
                        <InputSelect class="form-select" @bind-Value="selectedenqtype" style="font-size: 13px;">
                            <option value="">-- Select type --</option>
                            @foreach (var et in enquirytype)
                            {
                                <option value="@et">@et</option>
                            }
                        </InputSelect>
                        <div class="d-flex align-items-center mt-1">
                            <select class="form-select" multiple style="height: 75px; font-size: 13px;" @onchange="HandleEnqTypeListBoxSelection">
                                @foreach (var item in enqtypelistbox)
                                {
                                    <option value="@item">@item</option>
                                }
                            </select>
                            <div class="d-flex flex-column ms-1">
                                <button type="button" class="btn btn-outline-success mb-1" style="width: 36px; padding: 0.25rem 0.5rem;" @onclick="AddToListBoxenqtype">+</button>
                                <button type="button" class="btn btn-outline-danger" style="width: 36px; padding: 0.25rem 0.5rem;" @onclick="RemoveFromListBoxenqtype">-</button>
                            </div>
                        </div>
                        @if (inputErrors.ContainsKey("Enquirytype"))
                        {
                            <div class="text-danger" style="font-size: 11px;">@inputErrors["Enquirytype"]</div>
                        }
                    </div>
                </div>

                <div class="row mb-2">
                    <div class="col-md-3">
                        <label class="form-label" style="font-size: 13px;">Enquiry for<span class="text-danger">*</span></label>
                        <div class="input-group">
                            <InputText id="enquiryForInput_M" class="form-control" @bind-Value="selectedenqfor" style="font-size: 13px;"
                                       list="enquiryForList"
                                       @onblur="OnEnquiryForBlur" />
                            <datalist id="enquiryForList">
                                @foreach (var item in enquiryfor)
                                {
                                    <option value="@item"></option>
                                }
                            </datalist>
                            <button type="button" class="btn" style="font-size: 12px; padding: 0.25rem 0.5rem; background-color: #f0f0f0; color: black; border-color: #ccc;" @onclick="ToggleNewEnquiryForModal">New</button>
                            <button type="button" class="btn" style="font-size: 12px; padding: 0.25rem 0.5rem; background-color: #f0f0f0; color: black; border-color: #ccc;"
                                    @onclick="StartEditEnquiryFor" disabled="@(string.IsNullOrWhiteSpace(selectedenqfor))">
                                Edit
                            </button>
                        </div>
                        @if (inputErrors.ContainsKey("Enquiryfor") && inputErrors["Enquiryfor"] == NO_DATA_FOUND)
                        {
                            <div class="text-danger" style="font-size: 11px;">@inputErrors["Enquiryfor"]</div>
                        }
                        <div class="d-flex align-items-center mt-1">
                            <select class="form-select" multiple style="height: 75px; font-size: 13px;" @onchange="HandleEnqForListBoxSelection">
                                @foreach (var item in enqforlistbox)
                                {
                                    <option value="@item">@item</option>
                                }
                            </select>
                            <div class="d-flex flex-column ms-1">
                                <button type="button" class="btn btn-outline-success mb-1" style="width: 36px; padding: 0.25rem 0.5rem;" @onclick="AddToListBoxenqfor">+</button>
                                <button type="button" class="btn btn-outline-danger" style="width: 36px; padding: 0.25rem 0.5rem;" @onclick="RemoveFromListBoxenqfor">-</button>
                            </div>
                        </div>
                        @if (inputErrors.ContainsKey("Enquiryfor") && inputErrors["Enquiryfor"] != NO_DATA_FOUND)
                        {
                            <div class="text-danger" style="font-size: 11px;">@inputErrors["Enquiryfor"]</div>
                        }
                    </div>
                </div>

                @* === FIX 1: Changed Customer Name to Listbox === *@
                <div class="row mb-2">
                    <div class="col-md-3">
                        <label class="form-label" style="font-size: 13px;">Customer Name (Company Name)<span class="text-danger">*</span></label>
                        <div class="input-group">
                            <InputSelect class="form-select" @bind-Value="selectedCustomerInput" style="font-size: 13px;">
                                <option value="">-- Select Customer Company --</option>
                                @foreach (var c in existingCustomers)
                                {
                                    <option value="@c">@c</option>
                                }
                            </InputSelect>
                            <button type="button" class="btn" style="font-size: 12px; padding: 0.25rem 0.5rem; background-color: #f0f0f0; color: black; border-color: #ccc;" @onclick="ToggleNewCustomerInput">New</button>
                            <button type="button" class="btn" style="font-size: 12px; padding: 0.25rem 0.5rem; background-color: #f0f0f0; color: black; border-color: #ccc;" @onclick="StartEditCompany" disabled="@(string.IsNullOrWhiteSpace(selectedCustomerInput))">Edit</button>
                        </div>
                        @if (inputErrors.ContainsKey("CustomerName"))
                        {
                            <div class="text-danger" style="font-size: 11px;">@inputErrors["CustomerName"]</div>
                        }
                        <div class="d-flex align-items-center mt-1">
                            <select class="form-select" multiple style="height: 70px; font-size: 13px;" @onchange="HandleCustomerListBoxSelection">
                                @* === FIX 2: Numbered Listbox === *@
                                @foreach (var item in customerListBox.Select((name, index) => new { Name = name, Index = index + 1 }))
                                {
                                    <option value="@item.Name">@item.Index. @item.Name</option>
                                }
                            </select>
                            <div class="d-flex flex-column ms-1">
                                <button type="button" class="btn btn-outline-success mb-1" style="width: 36px; padding: 0.25rem 0.5rem;" @onclick="AddCustomerToListBox" disabled="@(string.IsNullOrWhiteSpace(selectedCustomerInput))">+</button>
                                <button type="button" class="btn btn-outline-danger" style="width: 36px; padding: 0.25rem 0.5rem;" @onclick="RemoveCustomerFromListBox" disabled="@(selectedCustomerListboxItems.Count == 0)">-</button>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-3">
                        <label class="form-label" style="font-size: 13px;">Received From (Contact Person)<span class="text-danger">*</span></label>
                        <div class="input-group">
                            @* === FIX 3: Dropdown is now filtered by customerListBox === *@
                            <InputSelect id="receivedContactSelect_M" class="form-select" @bind-Value="selectedReceivedContact" style="font-size: 13px;">
                                <option value="">-- Select Contact --</option>
                                @foreach (var contact in filteredReceivedFroms)
                                {
                                    var fullString = $"{contact.ContactName}{CONTACT_DELIMITER}{contact.CompanyName}";
                                    <option value="@fullString">@contact.ContactName (@contact.CompanyName)</option>
                                }
                            </InputSelect>
                            <button type="button" class="btn" style="font-size: 12px; padding: 0.25rem 0.5rem; background-color: #f0f0f0; color: black; border-color: #ccc;" @onclick="ToggleNewReceivedFromInput">New</button>
                            <button type="button" class="btn" style="font-size: 12px; padding: 0.25rem 0.5rem; background-color: #f0f0f0; color: black; border-color: #ccc;"
                                    @onclick="StartEditContact" disabled="@(!HasAnyContactSelection)">
                                Edit
                            </button>
                        </div>
                        @if (inputErrors.ContainsKey("ReceivedFrom"))
                        {
                            <div class="text-danger" style="font-size: 11px;">@inputErrors["ReceivedFrom"]</div>
                        }
                        <div class="d-flex align-items-center mt-1">
                            <select class="form-select" multiple style="height: 70px; font-size: 13px;" @onchange="HandleReceivedFromListBoxSelection">
                                @* === FIX 2: Numbered Listbox (Grouped by Customer) === *@
                                @foreach (var fullString in receivedContactListBox)
                                {
                                    var parts = fullString.Split(CONTACT_DELIMITER);
                                    if (parts.Length < 2) continue; // Safety check
                                    var contactName = parts[0];
                                    var companyName = parts[1];

                                    int companyIndex = customerListBox.IndexOf(companyName) + 1;
                                    string prefix = companyIndex > 0 ? $"{companyIndex}." : "-."; // Use index or a fallback

                                    <option value="@fullString">@prefix @contactName (@companyName)</option>
                                }
                            </select>
                            <div class="d-flex flex-column ms-1">
                                <button type="button" class="btn btn-outline-success mb-1" style="width: 36px; padding: 0.25rem 0.5rem;" @onclick="AddSelectedContactToListBox" disabled="@(string.IsNullOrWhiteSpace(selectedReceivedContact))">+</button>
                                <button type="button" class="btn btn-outline-danger" style="width: 36px; padding: 0.25rem 0.5rem;" @onclick="RemoveSelectedContactFromListBox" disabled="@(selectedReceivedFromListboxItems.Count == 0)">-</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row mb-2">
                    <div class="col-md-3">
                        <label class="form-label" style="font-size: 13px;">Project Name<span class="text-danger">*</span></label>
                        <InputText id="projectNameInput_M" class="form-control" @bind-Value="enquiryModel.ProjectName" style="font-size: 13px;"
                                   list="projectNameList"
                                   @oninput="@(() => ClearValidationError("ProjectName"))" />
                        <datalist id="projectNameList">
                            @foreach (var client in projectNames)
                            {
                                <option value="@client"></option>
                            }
                        </datalist>
                        @if (inputErrors.ContainsKey("ProjectName"))
                        {
                            <div class="text-danger" style="font-size: 11px;">@inputErrors["ProjectName"]</div>
                        }
                    </div>
                </div>

                <div class="row mb-2">
                    <div class="col-md-3">
                        <label class="form-label" style="font-size: 13px;">Client Name<span class="text-danger">*</span></label>
                        <div class="input-group">
                            <InputText id="clientNameInput_M" class="form-control" @bind-Value="enquiryModel.ClientName" style="font-size: 13px;"
                                       list="clientNameList"
                                       @onblur="OnClientNameBlur"
                                       @oninput="@(() => ClearValidationError("ClientName"))" />
                            <datalist id="clientNameList">
                                @foreach (var client in clientNames)
                                {
                                    <option value="@client"></option>
                                }
                            </datalist>
                            <button type="button" class="btn" style="font-size: 12px; padding: 0.25rem 0.5rem; background-color: #f0f0f0; color: black; border-color: #ccc;" @onclick="ToggleNewCustomerInput">New</button>
                            <button type="button" class="btn" style="font-size: 12px; padding: 0.25rem 0.5rem; background-color: #f0f0f0; color: black; border-color: #ccc;" @onclick="StartEditCompany" disabled="@(string.IsNullOrWhiteSpace(enquiryModel.ClientName))">Edit</button>
                        </div>
                        @if (inputErrors.ContainsKey("ClientName"))
                        {
                            <div class="text-danger" style="font-size: 11px;">@inputErrors["ClientName"]</div>
                        }
                    </div>
                </div>

                <div class="row mb-2">
                    <div class="col-md-3">
                        <label class="form-label" style="font-size: 13px;">Consultant Name</label>
                        <div class="input-group">
                            <InputText id="consultantNameInput_M" class="form-control" @bind-Value="enquiryModel.ConsultantName" style="font-size: 13px;"
                                       list="consultantNameList"
                                       @onblur="OnConsultantNameBlur" />
                            <datalist id="consultantNameList">
                                @foreach (var consultant in consultantNames)
                                {
                                    <option value="@consultant"></option>
                                }
                            </datalist>
                            <button type="button" class="btn" style="font-size: 12px; padding: 0.25rem 0.5rem; background-color: #f0f0f0; color: black; border-color: #ccc;" @onclick="ToggleNewCustomerInput">New</button>
                            <button type="button" class="btn" style="font-size: 12px; padding: 0.25rem 0.5rem; background-color: #f0f0f0; color: black; border-color: #ccc;" @onclick="StartEditCompany" disabled="@(string.IsNullOrWhiteSpace(enquiryModel.ConsultantName))">Edit</button>
                        </div>
                        @if (inputErrors.ContainsKey("ConsultantName"))
                        {
                            <div class="text-danger" style="font-size: 11px;">@inputErrors["ConsultantName"]</div>
                        }
                    </div>
                </div>

                <div class="row mb-2">
                    <div class="col-md-3">
                        <label class="form-label" style="font-size: 13px;">Concerned SE<span class="text-danger">*</span></label>
                        <div class="input-group">
                            <InputText id="concernedSEInput_M" class="form-control" @bind-Value="selectedSE" style="font-size: 13px;"
                                       list="concernedSEList"
                                       @onblur="OnConcernedSEBlur" />
                            <datalist id="concernedSEList">
                                @foreach (var se in concernedSEs)
                                {
                                    <option value="@se"></option>
                                }
                            </datalist>
                            <button type="button" class="btn" style="font-size: 12px; padding: 0.25rem 0.5rem; background-color: #f0f0f0; color: black; border-color: #ccc;" @onclick="ToggleNewUserModal">New</button>
                            <button type="button" class="btn" style="font-size: 12px; padding: 0.25rem 0.5rem; background-color: #f0f0f0; color: black; border-color: #ccc;"
                                    @onclick="StartEditUser" disabled="@(string.IsNullOrWhiteSpace(selectedSE))">
                                Edit
                            </button>
                        </div>
                        @if (inputErrors.ContainsKey("ConcernedSE"))
                        {
                            <div class="text-danger" style="font-size: 11px;">@inputErrors["ConcernedSE"]</div>
                        }
                        <div class="d-flex align-items-center mt-1">
                            <select class="form-select" multiple style="height: 70px; font-size: 13px;" @onchange="HandleSEListBoxSelection">
                                @foreach (var se in seListBox)
                                {
                                    <option value="@se">@se</option>
                                }
                            </select>
                            <div class="d-flex flex-column ms-1">
                                <button type="button" class="btn btn-outline-success mb-1" style="width: 36px; padding: 0.25rem 0.5rem;" @onclick="AddSEToListBoxToselectedSE">+</button>
                                <button type="button" class="btn btn-outline-danger" style="width: 36px; padding: 0.25rem 0.5rem;" @onclick="RemoveSEFromListBoxselectedSE">-</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row mb-3">
                    <div class="col-md-3">
                        <label class="form-label" style="font-size: 13px;">Enquiry details<span class="text-danger">*</span></label>
                        <InputTextArea class="form-control" @bind-Value="enquiryModel.DetailsOfEnquiry"
                                       @oninput="@(() => ClearValidationError("DetailsOfEnquiry"))"
                                       @onkeydown="HandleTextAreaKeyPress" />
                        @if (inputErrors.ContainsKey("DetailsOfEnquiry"))
                        {
                            <div class="text-danger" style="font-size: 11px;">@inputErrors["DetailsOfEnquiry"]</div>
                        }
                    </div>
                </div>

                <div class="row mb-2">
                    <div class="col-md-3">
                        <label class="form-label" style="font-size: 13px;">Document received along with the enquiry</label>
                        <div class="d-flex flex-wrap gap-2 mb-2" style="font-size: 13px;">
                            <div class="form-check form-check-inline">
                                <InputCheckbox class="form-check-input" @bind-Value="enquiryModel.hardcopy" id="hardcopyCheck_M" />
                                <label class="form-check-label" for="hardcopyCheck_M">Hard Copies</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <InputCheckbox class="form-check-input" @bind-Value="enquiryModel.drawing" id="drawingCheck_M" />
                                <label class="form-check-label" for="drawingCheck_M">Drawings</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <InputCheckbox class="form-check-input" @bind-Value="enquiryModel.dvd" id="dvdCheck_M" />
                                <label class="form-check-label" for="dvdCheck_M">CD/DVD</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <InputCheckbox class="form-check-input" @bind-Value="enquiryModel.spec" id="specCheck_M" />
                                <label class="form-check-label" for="specCheck_M">Specification</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <InputCheckbox class="form-check-input" @bind-Value="enquiryModel.eqpschedule" id="eqpscheduleCheck_M" />
                                <label class="form-check-label" for="eqpscheduleCheck_M">Equipment Schedule</label>
                            </div>
                        </div>
                        <label class="form-label" style="font-size: 13px;">Others Specify</label>
                        <InputTextArea class="form-control" @bind-Value="enquiryModel.DocumentsReceived" @onkeydown="HandleTextAreaKeyPress" />
                    </div>
                </div>

                <div class="row mb-2">
                    <div class="col-md-3">
                        <label class="form-label" style="font-size: 13px;">Remarks</label>
                        <InputTextArea class="form-control" @bind-Value="enquiryModel.Remark" @onkeydown="HandleTextAreaKeyPress" />
                    </div>
                </div>
                <div class="row mb-2">
                    <div class="col-md-3">
                        <div class="form-check" style="font-size: 13px;">
                            <InputCheckbox class="form-check-input" @bind-Value="enquiryModel.AutoAck" id="autoAckCheck_M" />
                            <label class="form-check-label" for="autoAckCheck_M">Is it necessary to send an acknowledgement mail to the customer ?</label>
                        </div>
                        <div class="form-check" style="font-size: 13px;">
                            <InputCheckbox class="form-check-input" @bind-Value="enquiryModel.ceosign" id="ceoSignCheck_M" />
                            <label class="form-check-label" for="ceoSignCheck_M">Is ED/CEO Signature required ? </label>
                        </div>
                    </div>
                </div>
                @* --- END: Full Form Structure for Modify --- *@

                <div class="row mt-4 mb-4" style="padding-bottom: 100px;">
                    <div class="col-12">
                        <button type="submit" class="btn btn-outline-success me-2"><i class="bi bi-save"></i> Save Changes</button>
                        <button type="button" class="btn btn-outline-danger me-2" @onclick="ClearModify"><i class="bi bi-x-circle"></i> Cancel</button>
                    </div>
                </div>
            </EditForm>
        }
    }

    @* ---------------- SEARCH ENQUIRY ---------------- *@
    @if (activeTab == "Search")
    {
        <div class="row g-2 mb-3">
            <div class="col-md-3">
                <label class="form-label" style="font-size:13px;">Search text</label>
                <InputText class="form-control" @bind-Value="searchText" placeholder="Request No / Customer / Client / Project / SE" />
            </div>
            <div class="col-md-2">
                <label class="form-label" style="font-size:13px;">Filter Category</label>
                <InputSelect class="form-select" @bind-Value="searchCategory">
                    <option value="All">All Categories</option>
                    <option value="SourceOfInfo">Source of Enquiry</option>
                    <option value="EnquiryType">Enquiry Type</option>
                    <option value="EnquiryFor">Enquiry For</option>
                    <option value="Status">Status</option>
                </InputSelect>
            </div>
            <div class="col-md-2">
                <label class="form-label" style="font-size:13px;">From date</label>
                <InputDate class="form-control" @bind-Value="searchFromDate" />
            </div>
            <div class="col-md-2">
                <label class="form-label" style="font-size:13px;">To date</label>
                <InputDate class="form-control" @bind-Value="searchToDate" />
            </div>
            <div class="col-md-3 d-flex align-items-end">
                <button class="btn btn-outline-primary me-2" @onclick="RunSearch"><i class="bi bi-search"></i> Search</button>
                <button class="btn btn-outline-secondary" @onclick="ClearSearch">Clear</button>
            </div>
        </div>

        @if (searchCategory != "All")
        {
            <div class="row g-2 mb-3">
                <div class="col-md-3">
                    <label class="form-label" style="font-size:13px;">Filter Value</label>
                    <InputSelect class="form-select" @bind-Value="searchCategoryValue">
                        <option value="">-- Select Value --</option>
                        @if (searchCategory == "SourceOfInfo")
                        {
                            @foreach (var val in sourceOfInfos)
                            {
                                <option value="@val">@val</option>
                            }
                        }
                        else if (searchCategory == "EnquiryType")
                        {
                            @foreach (var val in enquirytype)
                            {
                                <option value="@val">@val</option>
                            }
                        }
                        else if (searchCategory == "EnquiryFor")
                        {
                            @foreach (var val in enquiryfor)
                            {
                                <option value="@val">@val</option>
                            }
                        }
                        else if (searchCategory == "Status")
                        {
                            @foreach (var val in allStatuses)
                            {
                                <option value="@val">@val</option>
                            }
                        }
                    </InputSelect>
                </div>
            </div>
        }

        <div class="table-responsive">
            <table class="table table-sm table-hover align-middle">
                <thead class="table-light">
                    <tr>
                        <th>Request No</th>
                        <th>Enquiry Date</th>
                        <th>Customer</th>
                        <th>Client</th>
                        <th>Project</th>
                        <th>Source</th>
                        <th>Due</th>
                        <th>SE(s)</th>
                        <th>Status</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    @if (searchResults.Count == 0)
                    {
                        <tr><td colspan="10" class="text-muted">No results.</td></tr>
                    }
                    else
                    {
                        @foreach (var r in searchResults)
                        {
                            <tr>
                                <td>@r.RequestNo</td>
                                <td>@(r.EnquiryDate?.ToString("yyyy-MM-dd"))</td>
                                <td>@string.Join(", ", r.SelectedCustomers)</td>
                                <td>@r.ClientName</td>
                                <td>@r.ProjectName</td>
                                <td>@r.SourceOfInfo</td>
                                <td>@(r.DueOn?.ToString("yyyy-MM-dd"))</td>
                                <td>@string.Join(", ", r.SelectedConcernedSEs)</td>
                                <td>
                                    @r.Status
                                </td>
                                <td>
                                    @* === FIX 1: "Closed" Button Logic === *@
                                    @if (r.Status == "Reports")
                                    {
                                        <button class="btn btn-outline-success btn-sm" @onclick="() => OpenInModify(r.RequestNo, isClosed: true)">Closed</button>
                                    }
                                    else
                                    {
                                        <button class="btn btn-outline-primary btn-sm" @onclick="() => OpenInModify(r.RequestNo, isClosed: false)">Open</button>
                                    }
                                </td>
                            </tr>
                        }
                    }
                </tbody>
            </table>
        </div>
    }

</div>

@* === FIX 1: ADDED WARNING MODAL for saving closed requests === *@
<div class="modal @(showClosedWarningModal ? "d-block show" : "")" tabindex="-1" role="dialog" style="display: @(showClosedWarningModal ? "block" : "none"); background-color: rgba(0,0,0,0.5);">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title text-warning">Warning: Closed Request</h5>
                <button type="button" class="btn-close" aria-label="Close" @onclick="() => showClosedWarningModal = false"></button>
            </div>
            <div class="modal-body">
                <p>Please ensure before saving the changes as this request has already been closed.</p>
                <div class="form-check">
                    <InputCheckbox class="form-check-input" id="agreeCheck" @bind-Value="userAgreesToSaveClosed" />
                    <label class="form-check-label" for="agreeCheck">
                        I understand and agree to save these changes.
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" @onclick="() => showClosedWarningModal = false">Cancel</button>
                <button type="button" class="btn btn-primary" @onclick="HandleClosedWarningSave" disabled="@(!userAgreesToSaveClosed)">Save Changes</button>
            </div>
        </div>
    </div>
</div>


<div class="modal @(showCustomerModal ? "d-block show" : "")" tabindex="-1" role="dialog" style="display: @(showCustomerModal ? "block" : "none"); background-color: rgba(0,0,0,0.5);">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">CCC Details (@(modalMode == "Add" ? "New" : "Edit") Customer/Client/Consultant)</h5>
                <button type="button" class="btn-close" aria-label="Close" @onclick="CloseCustomerModal"></button>
            </div>
            <EditForm Model="@newCustomerCompany" OnValidSubmit="HandleNewCompanySubmit">
                <div class="modal-body">
                    <div class="row mb-2">
                        <div class="col-md-6">
                            <label class="form-label" style="font-size: 13px;">Category</label>
                            <InputSelect class="form-select" @bind-Value="newCustomerCompany.Category" style="font-size: 13px;">
                                <option>Contractor</option>
                                <option>Client</option>
                                <option>Consultant</option>
                            </InputSelect>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label" style="font-size: 13px;">Company Name<span class="text-danger">*</span></label>
                            <InputText class="form-control" @bind-Value="newCustomerCompany.CompanyName" style="font-size: 13px;" />
                        </div>
                    </div>
                    <div class="row mb-2">
                        <div class="col-md-6">
                            <label class="form-label" style="font-size: 13px;">Address 1<span class="text-danger">*</span></label>
                            <InputTextArea class="form-control" @bind-Value="newCustomerCompany.Address1" style="font-size: 13px;" />
                        </div>
                        <div class="col-md-6">
                            <label class="form-label" style="font-size: 13px;">Address 2</label>
                            <InputTextArea class="form-control" @bind-Value="newCustomerCompany.Address2" style="font-size: 13px;" />
                        </div>
                    </div>
                    <div class="row mb-2">
                        <div class="col-md-3">
                            <label class="form-label" style="font-size: 13px;">Rating</label>
                            <InputText class="form-control" @bind-Value="newCustomerCompany.Rating" style="font-size: 13px;" />
                        </div>
                        <div class="col-md-3">
                            <label class="form-label" style="font-size: 13px;">Type</label>
                            <InputSelect class="form-select" @bind-Value="newCustomerCompany.Type" style="font-size: 13px;">
                                <option value="">-- Select Type --</option>
                                @foreach (var t in consultantTypeOptions)
                                {
                                    <option value="@t">@t</option>
                                }
                            </InputSelect>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label" style="font-size: 13px;">Fax No.</label>
                            <InputText class="form-control" @bind-Value="newCustomerCompany.FaxNo" style="font-size: 13px;" />
                        </div>
                    </div>
                    <div class="row mb-2">
                        <div class="col-md-6">
                            <label class="form-label" style="font-size: 13px;">Phone 1<span class="text-danger">*</span></label>
                            <InputText class="form-control" @bind-Value="newCustomerCompany.Phone1" style="font-size: 13px;" />
                        </div>
                        <div class="col-md-6">
                            <label class="form-label" style="font-size: 13px;">Phone 2</label>
                            <InputText class="form-control" @bind-Value="newCustomerCompany.Phone2" style="font-size: 13px;" />
                        </div>
                    </div>
                    <div class="row mb-2">
                        <div class="col-md-6">
                            <label class="form-label" style="font-size: 13px;">E-Mail ID</label>
                            <InputText class="form-control" @bind-Value="newCustomerCompany.MailId" style="font-size: 13px;" />
                        </div>
                        <div class="col-md-6">
                            <label class="form-label" style="font-size: 13px;">Website</label>
                            <InputText class="form-control" @bind-Value="newCustomerCompany.Website" style="font-size: 13px;" />
                        </div>
                    </div>
                    <div class="row mb-2">
                        <div class="col-md-6">
                            <label class="form-label" style="font-size: 13px;">Status</label>
                            <InputSelect class="form-select" @bind-Value="newCustomerCompany.Status" style="font-size: 13px;">
                                <option>Active</option>
                                <option>Inactive</option>
                            </InputSelect>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    @if (modalMode == "Add")
                    {
                        <button type="submit" class="btn btn-primary" style="width: 80px;">Add</button>
                    }
                    else if (modalMode == "Edit")
                    {
                        <button type="submit" class="btn btn-primary" style="width: 80px;">Update</button>
                    }
                    <button type="button" class="btn btn-danger" style="width: 80px;" @onclick="CloseCustomerModal">Cancel</button>
                </div>
            </EditForm>
        </div>
    </div>
</div>

<div class="modal @(showContactModal ? "d-block show" : "")" tabindex="-1" role="dialog" style="display: @(showContactModal ? "block" : "none"); background-color: rgba(0,0,0,0.5);">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Contact Person Details (@(modalMode == "Add" ? "New" : "Edit") Contact Person)</h5>
                <button type="button" class="btn-close" aria-label="Close" @onclick="CloseContactModal"></button>
            </div>
            <EditForm Model="@modalContactPerson" OnValidSubmit="HandleNewContactSubmit">
                <div class="modal-body">
                    <div class="row mb-2">
                        <div class="col-md-6">
                            <label class="form-label" style="font-size: 13px;">Category</label>
                            <InputSelect class="form-select" @bind-Value="modalContactPerson.Category" style="font-size: 13px;">
                                <option>Contractor</option>
                                <option>Client</option>
                                <option>Consultant</option>
                            </InputSelect>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label" style="font-size: 13px;">Company Name<span class="text-danger">*</span></label>
                            <InputText class="form-control" @bind-Value="modalContactPerson.CompanyName" style="font-size: 13px;" />
                        </div>
                    </div>
                    <div class="row mb-2">
                        <div class="col-md-6">
                            <label class="form-label" style="font-size: 13px;">Contact Person Name<span class="text-danger">*</span></label>
                            <InputText class="form-control" @bind-Value="modalContactPerson.ContactName" style="font-size: 13px;" />
                        </div>
                        <div class="col-md-6">
                            <label class="form-label" style="font-size: 13px;">Designation</label>
                            <InputText class="form-control" @bind-Value="modalContactPerson.Designation" style="font-size: 13px;" />
                        </div>
                    </div>
                    <div class="row mb-2">
                        <div class="col-md-6">
                            <label class="form-label" style="font-size: 13px;">Category of Designation</label>
                            <InputSelect class="form-select" @bind-Value="modalContactPerson.CategoryOfDesignation" style="font-size: 13px;">
                                <option>Technical</option>
                                <option>General</option>
                            </InputSelect>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label" style="font-size: 13px;">Address 1<span class="text-danger">*</span></label>
                            <InputTextArea class="form-control" @bind-Value="modalContactPerson.Address1" style="font-size: 13px;" />
                        </div>
                    </div>
                    <div class="row mb-2">
                        <div class="col-md-6">
                            <label class="form-label" style="font-size: 13px;">Address 2</label>
                            <InputTextArea class="form-control" @bind-Value="modalContactPerson.Address2" style="font-size: 13px;" />
                        </div>
                        <div class="col-md-6">
                            <label class="form-label" style="font-size: 13px;">Fax No.</label>
                            <InputText class="form-control" @bind-Value="modalContactPerson.FaxNo" style="font-size: 13px;" />
                        </div>
                    </div>
                    <div class="row mb-2">
                        <div class="col-md-6">
                            <label class="form-label" style="font-size: 13px;">Phone</label>
                            <InputText class="form-control" @bind-Value="modalContactPerson.Phone" style="font-size: 13px;" />
                        </div>
                        <div class="col-md-6">
                            <label class="form-label" style="font-size: 13px;">Mobile 1</label>
                            <InputText class="form-control" @bind-Value="modalContactPerson.Mobile1" style="font-size: 13px;" />
                        </div>
                    </div>
                    <div class="row mb-2">
                        <div class="col-md-6">
                            <label class="form-label" style="font-size: 13px;">Mobile 2</label>
                            <InputText class="form-control" @bind-Value="modalContactPerson.Mobile2" style="font-size: 13px;" />
                        </div>
                        <div class="col-md-6">
                            <label class="form-label" style="font-size: 13px;">E-Mail ID</label>
                            <InputText class="form-control" @bind-Value="modalContactPerson.EmailId" style="font-size: 13px;" />
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    @if (modalMode == "Add")
                    {
                        <button type="submit" class="btn btn-primary" style="width: 80px;">Add</button>
                    }
                    else if (modalMode == "Edit")
                    {
                        <button type="submit" class="btn btn-primary" style="width: 80px;">Update</button>
                    }
                    <button type="button" class="btn btn-danger" style="width: 80px;" @onclick="OnCancelContact">Cancel</button>
                </div>
            </EditForm>
        </div>
    </div>
</div>

<div class="modal @(showUserModal ? "d-block show" : "")" tabindex="-1" role="dialog" style="display: @(showUserModal ? "block" : "none"); background-color: rgba(0,0,0,0.5);">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">User Details (@(modalMode == "Add" ? "New" : "Edit") User)</h5>
                <button type="button" class="btn-close" aria-label="Close" @onclick="CloseUserModal"></button>
            </div>
            <EditForm Model="@newUserModel" OnValidSubmit="HandleNewUserSubmit">
                <div class="modal-body">
                    <div class="row mb-2">
                        <div class="col-md-6">
                            <label class="form-label" style="font-size: 13px;">Full Name<span class="text-danger">*</span></label>
                            <InputText class="form-control" @bind-Value="newUserModel.FullName" style="font-size: 13px;" />
                        </div>
                        <div class="col-md-6">
                            <label class="form-label" style="font-size: 13px;">Designation</label>
                            <InputText class="form-control" @bind-Value="newUserModel.Designation" style="font-size: 13px;" />
                        </div>
                    </div>
                    <div class="row mb-2">
                        <div class="col-md-6">
                            <label class="form-label" style="font-size: 13px;">E-Mail ID<span class="text-danger">*</span></label>
                            <InputText class="form-control" @bind-Value="newUserModel.MailId" style="font-size: 13px;" />
                        </div>
                        <div class="col-md-6">
                            <label class="form-label" style="font-size: 13px;">Login Password<span class="text-danger">*</span></label>
                            <InputText class="form-control" @bind-Value="newUserModel.LoginPassword" style="font-size: 13px;" />
                        </div>
                    </div>
                    <div class="row mb-2">
                        <div class="col-md-3">
                            <label class="form-label" style="font-size: 13px;">Status</label>
                            <InputSelect class="form-select" @bind-Value="newUserModel.Status" style="font-size: 13px;">
                                <option>Active</option>
                                <option>Inactive</option>
                            </InputSelect>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label" style="font-size: 13px;">Department</label>
                            <InputSelect class="form-select" @bind-Value="newUserModel.Department" style="font-size: 13px;">
                                <option>MEP</option>
                                <option>Civil</option>
                            </InputSelect>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label" style="font-size: 13px;">Roles</label>
                            <InputSelect class="form-select mb-1" @bind-Value="newRoleEntry" style="font-size: 13px;">
                                <option value="">-- Select Role --</option>
                                @foreach (var role in availableRoles)
                                {
                                    <option value="@role">@role</option>
                                }
                            </InputSelect>
                            <div class="d-flex align-items-center mt-1">
                                <select class="form-select" multiple style="height: 70px; font-size: 13px;" @onchange="HandleRoleListBoxSelection">
                                    @foreach (var role in newUserModel.Roles)
                                    {
                                        <option value="@role">@role</option>
                                    }
                                </select>
                                <div class="d-flex flex-column ms-1">
                                    <button type="button" class="btn btn-outline-success mb-1" style="width: 36px; padding: 0.25rem 0.5rem;" @onclick="AddRoleToListBox">+</button>
                                    <button type="button" class="btn btn-outline-danger" style="width: 36px; padding: 0.25rem 0.5rem;" @onclick="RemoveRoleFromListBox">-</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    @if (modalMode == "Add")
                    {
                        <button type="submit" class="btn btn-primary" style="width: 80px;">Add</button>
                    }
                    else if (modalMode == "Edit")
                    {
                        <button type="submit" class="btn btn-primary" style="width: 80px;">Update</button>
                    }
                    <button type="button" class="btn btn-danger" style="width: 80px;" @onclick="CloseUserModal">Cancel</button>
                </div>
            </EditForm>
        </div>
    </div>
</div>

<div class="modal @(showEnqForModal ? "d-block show" : "")" tabindex="-1" role="dialog" style="display: @(showEnqForModal ? "block" : "none"); background-color: rgba(0,0,0,0.5);">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Enquiry For Item Details (@(modalMode == "Add" ? "New" : "Edit") Item)</h5>
                <button type="button" class="btn-close" aria-label="Close" @onclick="CloseEnqForModal"></button>
            </div>
            <EditForm Model="@newEnquiryForItem" OnValidSubmit="HandleNewEnquiryForItemSubmit">
                <div class="modal-body">
                    <div class="row mb-2">
                        <div class="col-md-6">
                            <label class="form-label" style="font-size: 13px;">Item Name<span class="text-danger">*</span></label>
                            <InputText class="form-control" @bind-Value="newEnquiryForItem.ItemName" style="font-size: 13px;" />
                        </div>
                        <div class="col-md-6">
                            <label class="form-label" style="font-size: 13px;">Company Name (Dept)</label>
                            <InputText class="form-control" @bind-Value="newEnquiryForItem.CompanyName" style="font-size: 13px;" />
                        </div>
                    </div>
                    <div class="row mb-2">
                        <div class="col-md-3">
                            <label class="form-label" style="font-size: 13px;">Department Name</label>
                            <InputText class="form-control" @bind-Value="newEnquiryForItem.DepartmentName" style="font-size: 13px;" />
                        </div>
                        <div class="col-md-3">
                            <label class="form-label" style="font-size: 13px;">Status</label>
                            <InputSelect class="form-select" @bind-Value="newEnquiryForItem.Status" style="font-size: 13px;">
                                <option>Active</option>
                                <option>Inactive</option>
                            </InputSelect>
                        </div>
                    </div>
                    <div class="row mb-2">
                        <div class="col-md-6">
                            <label class="form-label" style="font-size: 13px;">Common mail ID to send notification</label>
                            <InputText id="commonMailInput" class="form-control" @bind-Value="newCommonMailEntry" style="font-size: 13px;" placeholder="Enter email address" />
                            <div class="d-flex align-items-center mt-1">
                                <select class="form-select" multiple style="height: 75px; font-size: 13px;" @onchange="HandleCommonMailListBoxSelection">
                                    @foreach (var item in newEnquiryForItem.CommonMailIds)
                                    {
                                        <option value="@item">@item</option>
                                    }
                                </select>
                                <div class="d-flex flex-column ms-1">
                                    <button type="button" class="btn btn-outline-success mb-1" style="width: 36px; padding: 0.25rem 0.5rem;" @onclick="AddCommonMailToListBox">+</button>
                                    <button type="button" class="btn btn-outline-danger" style="width: 36px; padding: 0.25rem 0.5rem;" @onclick="RemoveCommonMailFromListBox">-</button>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label" style="font-size: 13px;">CC mail ID to send notification</label>
                            <InputText id="ccMailInput" class="form-control" @bind-Value="newCCMailEntry" style="font-size: 13px;" placeholder="Enter email address" />
                            <div class="d-flex align-items-center mt-1">
                                <select class="form-select" multiple style="height: 75px; font-size: 13px;" @onchange="HandleCCMailListBoxSelection">
                                    @foreach (var item in newEnquiryForItem.CCMailIds)
                                    {
                                        <option value="@item">@item</option>
                                    }
                                </select>
                                <div class="d-flex flex-column ms-1">
                                    <button type="button" class="btn btn-outline-success mb-1" style="width: 36px; padding: 0.25rem 0.5rem;" @onclick="AddCCMailToListBox">+</button>
                                    <button type="button" class="btn btn-outline-danger" style="width: 36px; padding: 0.25rem 0.5rem;" @onclick="RemoveCCMailFromListBox">-</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    @if (modalMode == "Add")
                    {
                        <button type="submit" class="btn btn-primary" style="width: 80px;">Add</button>
                    }
                    else if (modalMode == "Edit")
                    {
                        <button type="submit" class="btn btn-primary" style="width: 80px;">Update</button>
                    }
                    <button type="button" class="btn btn-danger" style="width: 80px;" @onclick="CloseEnqForModal">Cancel</button>
                </div>
            </EditForm>
        </div>
    </div>
</div>

@code {

#nullable enable

    // ---------- MODELS (UPDATED) ----------
    public class EnquiryModel
    {
        public string SourceOfInfo { get; set; } = string.Empty;
        public DateTime? EnquiryDate { get; set; } = DateTime.Now.Date;
        public DateTime? DueOn { get; set; } = null;
        public DateTime? SiteVisitDate { get; set; } = null;
        public string ProjectName { get; set; } = string.Empty;
        public string ClientName { get; set; } = string.Empty;
        public string ConsultantName { get; set; } = string.Empty;
        public string DetailsOfEnquiry { get; set; } = string.Empty;
        public string DocumentsReceived { get; set; } = string.Empty;
        public bool hardcopy { get; set; } = false;
        public bool drawing { get; set; } = false;
        public bool dvd { get; set; } = false;
        public bool spec { get; set; } = false;
        public bool eqpschedule { get; set; } = false;
        public string Remark { get; set; } = string.Empty;
        public bool AutoAck { get; set; } = true;
        public bool ceosign { get; set; } = false;
        public List<string> SelectedEnquiryTypes { get; set; } = new();
        public List<string> SelectedEnquiryFor { get; set; } = new();
        public List<string> SelectedCustomers { get; set; } = new();
        public List<string> SelectedReceivedFroms { get; set; } = new();
        public List<string> SelectedConcernedSEs { get; set; } = new();
        public string Status { get; set; } = "Enquiry"; // FIX 3: Default status updated
    }

    public class ContactPersonModel
    {
        public string Category { get; set; } = "Contractor";
        public string CompanyName { get; set; } = string.Empty;
        public string ContactName { get; set; } = string.Empty;
        public string Designation { get; set; } = string.Empty;
        public string CategoryOfDesignation { get; set; } = "Technical";
        public string Address1 { get; set; } = string.Empty;
        public string Address2 { get; set; } = string.Empty;
        public string FaxNo { get; set; } = string.Empty;
        public string Phone { get; set; } = string.Empty;
        public string Mobile1 { get; set; } = string.Empty;
        public string Mobile2 { get; set; } = string.Empty;
        public string EmailId { get; set; } = string.Empty;
        public string UniqueKey => $"{ContactName}{CONTACT_DELIMITER}{CompanyName}";
        public static ContactPersonModel Clone(ContactPersonModel o) => new()
        {
            Category = o.Category,
            CompanyName = o.CompanyName,
            ContactName = o.ContactName,
            Designation = o.Designation,
            CategoryOfDesignation = o.CategoryOfDesignation,
            Address1 = o.Address1,
            Address2 = o.Address2,
            FaxNo = o.FaxNo,
            Phone = o.Phone,
            Mobile1 = o.Mobile1,
            Mobile2 = o.Mobile2,
            EmailId = o.EmailId
        };
    }

    public class CustomerCompanyModel
    {
        public string Category { get; set; } = "Contractor";
        public string CompanyName { get; set; } = string.Empty;
        public string Address1 { get; set; } = string.Empty;
        public string Address2 { get; set; } = string.Empty;
        public string Rating { get; set; } = string.Empty;
        public string Type { get; set; } = string.Empty;
        public string FaxNo { get; set; } = string.Empty;
        public string Phone1 { get; set; } = string.Empty;
        public string Phone2 { get; set; } = string.Empty;
        public string MailId { get; set; } = string.Empty;
        public string Website { get; set; } = string.Empty;
        public string Status { get; set; } = "Active";
        public static CustomerCompanyModel Clone(CustomerCompanyModel o) => new()
        {
            Category = o.Category,
            CompanyName = o.CompanyName,
            Address1 = o.Address1,
            Address2 = o.Address2,
            Rating = o.Rating,
            Type = o.Type,
            FaxNo = o.FaxNo,
            Phone1 = o.Phone1,
            Phone2 = o.Phone2,
            MailId = o.MailId,
            Website = o.Website,
            Status = o.Status
        };
        public static CustomerCompanyModel FromContact(ContactPersonModel c) => new()
        {
            Category = c.Category,
            CompanyName = c.CompanyName,
            Address1 = c.Address1,
            Address2 = c.Address2,
            Phone1 = c.Phone,
            MailId = c.EmailId,
            Status = "Active"
        };
    }

    public class UserModel
    {
        public string FullName { get; set; } = string.Empty;
        public string Designation { get; set; } = string.Empty;
        public string MailId { get; set; } = string.Empty;
        public string LoginPassword { get; set; } = string.Empty;
        public string Status { get; set; } = "Active";
        public string Department { get; set; } = "MEP";
        public List<string> Roles { get; set; } = new();
        public static UserModel Clone(UserModel o) => new()
        {
            FullName = o.FullName,
            Designation = o.Designation,
            MailId = o.MailId,
            LoginPassword = o.LoginPassword,
            Status = o.Status,
            Department = o.Department,
            Roles = o.Roles.ToList()
        };
    }

    public class EnquiryForItemModel
    {
        public string ItemName { get; set; } = string.Empty;
        public string CompanyName { get; set; } = string.Empty;
        public string DepartmentName { get; set; } = string.Empty;
        public string Status { get; set; } = "Active";
        public List<string> CommonMailIds { get; set; } = new();
        public List<string> CCMailIds { get; set; } = new();
        public static EnquiryForItemModel Clone(EnquiryForItemModel o) => new()
        {
            ItemName = o.ItemName,
            CompanyName = o.CompanyName,
            DepartmentName = o.DepartmentName,
            Status = o.Status,
            CommonMailIds = o.CommonMailIds.ToList(),
            CCMailIds = o.CCMailIds.ToList()
        };
    }

    public class EnquirySnapshot
    {
        public string RequestNo { get; set; } = string.Empty;
        public string SourceOfInfo { get; set; } = string.Empty;
        public DateTime? EnquiryDate { get; set; }
        public DateTime? DueOn { get; set; }
        public DateTime? SiteVisitDate { get; set; }
        public string ProjectName { get; set; } = string.Empty;
        public string ClientName { get; set; } = string.Empty;
        public string ConsultantName { get; set; } = string.Empty;
        public string DetailsOfEnquiry { get; set; } = string.Empty;
        public string DocumentsReceived { get; set; } = string.Empty;
        public bool hardcopy { get; set; }
        public bool drawing { get; set; }
        public bool dvd { get; set; }
        public bool spec { get; set; }
        public bool eqpschedule { get; set; }
        public string Remark { get; set; } = string.Empty;
        public bool AutoAck { get; set; }
        public bool ceosign { get; set; }
        public List<string> SelectedEnquiryTypes { get; set; } = new();
        public List<string> SelectedEnquiryFor { get; set; } = new();
        public List<string> SelectedCustomers { get; set; } = new();
        public List<string> SelectedReceivedFroms { get; set; } = new();
        public List<string> SelectedConcernedSEs { get; set; } = new();
        public string Status { get; set; } = "Enquiry"; // FIX 3: Default status updated
    }

    // ---------- CONSTANTS / STATE ----------
    private const char CONTACT_DELIMITER = '|';
    private const string NO_DATA_FOUND = "No data found, please use 'New' button to add.";
    private Dictionary<string, string> inputErrors = new();

    private EnquiryModel enquiryModel = new();
    private CustomerCompanyModel newCustomerCompany = new();
    private CustomerCompanyModel? companyToEdit = null;
    private ContactPersonModel modalContactPerson = new();
    private ContactPersonModel? contactToEdit = null;
    private UserModel newUserModel = new();
    private UserModel? userToEdit = null;
    private EnquiryForItemModel newEnquiryForItem = new();
    private EnquiryForItemModel? enqItemToEdit = null;
    private CustomerCompanyModel? newCustomerCompanyFromContact = null;

    private string activeTab = "New";
    private string GetTabClass(string tab) => $"nav-link {(activeTab == tab ? "active" : "")}";
    private void SwitchTab(string tab) { activeTab = tab; StateHasChanged(); }
    private void OnClickTabNew() => SwitchTab("New");
    private void OnClickTabModify() => SwitchTab("Modify");
    private void OnClickTabSearch()
    {
        SwitchTab("Search");
        RunSearch();
    }

    private Dictionary<string, EnquirySnapshot> enquiriesDb = new();

    // lists
    private List<string> sourceOfInfos = new() {
        "Email","Phone","Tender Board","Customer Visit","Cold visit by us","Website","Fax","Thru top management","News Paper"
    };
    private List<string> enquirytype = new() {
        "New Tender","Re-Tender","Job in hand","Variation / Change order","Supply only","Maintenance","Retrofit",
        "Upgradation","Refurbishment","Service","Hiring","Renting","Facility Management","Demo"
    };
    private List<string> consultantTypeOptions = new() {
        "MEP","HVAC","Electrical","Plumbing","Fire Fighting","BMS","ELV","Civil","Piling","Scaffolding",
        "Cleaning","Security","Maintenance","Transport","Interior","Landscape","Carpentry","Aluminium","Real estate","Facility Management"
    };
    // FIX 3: Updated status list
    private List<string> allStatuses = new() {
        "Enquiry", "Pricing", "Quote", "Probability", "Reports"
    };

    private List<string> availableRoles = new() { "Enquiry", "Quotation", "Sales", "Admin" };
    private List<string> projectNames = new() { "Project Alpha", "Project Beta" };
    private List<string> existingCustomers = new();
    private List<string> clientNames = new();
    private List<string> consultantNames = new();
    private List<string> concernedSEs = new();
    private List<string> enquiryfor = new();
    private List<ContactPersonModel> allReceivedFroms = new();
    private List<ContactPersonModel> filteredReceivedFroms = new();

    // simulated master
    private List<UserModel> storedUsers = new() {
        new UserModel { FullName = "SE1 - John Doe", Designation = "Sales Engineer", MailId = "se1@comp.com", Status = "Active", Roles = new() { "Enquiry", "Quotation" } },
        new UserModel { FullName = "SE2 - Jane Smith", Designation = "Sales Manager", MailId = "se2@comp.com", Status = "Active", Roles = new() { "Enquiry", "Admin" } },
    };
    private List<ContactPersonModel> storedContacts = new() {
        new ContactPersonModel { ContactName = "Velu", CompanyName = "Customer X Ltd", EmailId = "pa@custx.com", Category = "Contractor", Designation = "Manager", Address1 = "123 Main St", Mobile1 = "333" },
        new ContactPersonModel { ContactName = "Vijay", CompanyName = "Customer Y Corp", EmailId = "pb@custy.com", Category = "Contractor", Designation = "Director", Address1 = "456 Oak Ave", Mobile1 = "666" },
        new ContactPersonModel { ContactName = "Seema", CompanyName = "Customer X Ltd", EmailId = "sc@custx.com", Category = "Contractor", Designation = "Engineer", Address1 = "123 Main St", Mobile1 = "333" },
        new ContactPersonModel { ContactName = "Person C - Engineer", CompanyName = "Client Z Inc", EmailId = "pc@clientz.com", Category = "Client", Designation = "Engineer", Address1 = "789 Pine Rd", Mobile1 = "999" }
    };
    private List<CustomerCompanyModel> storedCustomers = new() {
        new CustomerCompanyModel { CompanyName = "Customer X Ltd", Category = "Contractor", Status = "Active", Address1 = "123 Main St", Phone1 = "222" },
        new CustomerCompanyModel { CompanyName = "Customer Y Corp", Category = "Contractor", Status = "Active", Address1 = "456 Oak Ave", Phone1 = "555" },
        new CustomerCompanyModel { CompanyName = "Client Z Inc", Category = "Client", Status = "Active", Address1 = "789 Pine Rd", Phone1 = "888" },
        new CustomerCompanyModel { CompanyName = "Consultant A", Category = "Consultant", Status = "Active", Address1 = "101 Elm Blvd", Phone1 = "000" }
    };
    private List<EnquiryForItemModel> storedEnqItems = new() {
        new EnquiryForItemModel { ItemName = "Electrical", DepartmentName = "Elect", CommonMailIds = new() { "elect_common@a.com" }, Status = "Active" },
        new EnquiryForItemModel { ItemName = "Mechanical", DepartmentName = "Mech", CCMailIds = new() { "mech_cc1@b.com" }, Status = "Active" }
    };

    // tracking
    private string? selectedSE;
    private List<string> seListBox = new();
    private string? selectedenqtype;
    private List<string> enqtypelistbox = new();
    private string? selectedenqfor;
    private List<string> enqforlistbox = new();

    // FIX 1: Updated Customer variables
    private string? selectedCustomerInput; // Holds the dropdown selection
    private List<string> customerListBox = new(); // Holds the selected companies
    private List<string> selectedCustomerListboxItems = new(); // Holds items selected in the listbox for removal

    private string? selectedReceivedContact;
    private List<string> receivedContactListBox = new();

    private List<string> selectedReceivedFromListboxItems = new();
    private List<string> selectedSEListboxItems = new();
    private List<string> selectedEnqTypeListboxItems = new();
    private List<string> selectedEnqForListboxItems = new();
    private string newRoleEntry = string.Empty;
    private string newCommonMailEntry = string.Empty;
    private string newCCMailEntry = string.Empty;
    private List<string> selectedRoleListboxItems = new();
    private List<string> selectedCommonMailListboxItems = new();
    private List<string> selectedCCMailListboxItems = new();

    private bool showCustomerModal = false;
    private bool showContactModal = false;
    private bool showUserModal = false;
    private bool showEnqForModal = false;
    private string modalMode = "Add";

    // === FIX 1: NEW State variables for "Closed" warning ===
    private bool isModifyingClosedRequest = false;
    private bool showClosedWarningModal = false;
    private bool userAgreesToSaveClosed = false;
    // ======================================================

    private bool HasAnyContactSelection =>
        !string.IsNullOrWhiteSpace(selectedReceivedContact) || selectedReceivedFromListboxItems.Count > 0;

    private string searchCategory = "All";
    private string searchCategoryValue = string.Empty;


    // ---------- LIFECYCLE (UPDATED) ----------
    protected override void OnInitialized()
    {
        UpdateAllListsFromStorage();
        UpdateReceivedFromList();

        if (!enquiriesDb.Any())
        {
            var initialSnap = new EnquirySnapshot
            {
                RequestNo = "EYS/2025/11/001",
                SourceOfInfo = "Phone",
                EnquiryDate = new DateTime(2025, 11, 12),
                DueOn = new DateTime(2025, 11, 19),
                SiteVisitDate = new DateTime(2025, 11, 27),
                SelectedEnquiryTypes = new List<string> { "Re-Tender" },
                SelectedEnquiryFor = new List<string> { "Electrical" },
                SelectedCustomers = new List<string> { "Customer X Ltd" }, // FIX 1: Can now hold multiple
                SelectedReceivedFroms = new List<string> { "Seema|Customer X Ltd" },
                ProjectName = "Project Alpha",
                ClientName = "Client Z Inc",
                ConsultantName = "Consultant A",
                SelectedConcernedSEs = new List<string> { "SE2 - Jane Smith" },
                DetailsOfEnquiry = "zsdcfhbjnm",
                hardcopy = true,
                drawing = true,
                dvd = false,
                spec = false,
                eqpschedule = false,
                DocumentsReceived = "xcvyb",
                Remark = "excryybun",
                AutoAck = true,
                ceosign = false,
                Status = "Enquiry" // FIX 3: Default status updated
            };
            enquiriesDb.Add(initialSnap.RequestNo, initialSnap);
        }
        RunSearch();
    }

    private void UpdateAllListsFromStorage()
    {
        existingCustomers = storedCustomers.Where(c => c.Category == "Contractor" && c.Status == "Active").Select(c => c.CompanyName).Distinct().ToList();
        clientNames = storedCustomers.Where(c => c.Category == "Client" && c.Status == "Active").Select(c => c.CompanyName).Distinct().ToList();
        consultantNames = storedCustomers.Where(c => c.Category == "Consultant" && c.Status == "Active").Select(c => c.CompanyName).Distinct().ToList();
        concernedSEs = storedUsers.Where(u => u.Status == "Active").Select(u => u.FullName).Distinct().ToList();
        enquiryfor = storedEnqItems.Where(i => i.Status == "Active").Select(i => i.ItemName).Distinct().ToList();
        allReceivedFroms = storedContacts.ToList();

        // FIX 1: This method now just populates ALL contacts
        UpdateReceivedFromList();

        StateHasChanged();
    }

    // === FIX 3: UPDATED method to filter dropdown based on customerListBox ===
    private void UpdateReceivedFromList()
    {
        if (customerListBox.Count > 0)
        {
            // Filter by companies in the listbox
            var customerSet = customerListBox.ToHashSet(StringComparer.OrdinalIgnoreCase);
            filteredReceivedFroms = allReceivedFroms
                .Where(c => c.Category == "Contractor" && customerSet.Contains(c.CompanyName))
                .OrderBy(c => c.CompanyName).ThenBy(c => c.ContactName)
                .ToList();
        }
        else
        {
            // No customers selected, show all contacts
            filteredReceivedFroms = allReceivedFroms
                .Where(c => c.Category == "Contractor")
                .OrderBy(c => c.CompanyName).ThenBy(c => c.ContactName)
                .ToList();
        }

        // Clear selection if it's no longer in the filtered list
        if (!string.IsNullOrWhiteSpace(selectedReceivedContact) && !filteredReceivedFroms.Any(c => c.UniqueKey == selectedReceivedContact))
        {
            selectedReceivedContact = null;
        }

        StateHasChanged();
    }

    // ---------- DROPDOWN HANDLERS (New/Modified) ----------

    // FIX 1: This no longer does anything except set the input
    private void OnCustomerDropdownChange(ChangeEventArgs e)
    {
        selectedCustomerInput = (e.Value ?? string.Empty).ToString().Trim();
        StateHasChanged();
    }

    // ---------- FIELD BLUR HELPERS (no params, to avoid quote issues) ----------

    private void OnEnquiryForBlur()
    {
        ValidateControlledInput(selectedenqfor, enquiryfor, "Enquiryfor");
        StateHasChanged();
    }

    private void OnClientNameBlur()
    {
        ValidateControlledInput(enquiryModel.ClientName, clientNames, "ClientName");
        StateHasChanged();
    }
    private void OnConsultantNameBlur()
    {
        ValidateControlledInput(enquiryModel.ConsultantName, consultantNames, "ConsultantName");
        StateHasChanged();
    }
    private void OnConcernedSEBlur()
    {
        ValidateControlledInput(selectedSE, concernedSEs, "ConcernedSE");
        StateHasChanged();
    }

    // ---------- LISTBOX HANDLERS ----------

    private List<string> GetSelectedItemsFromChange(ChangeEventArgs e)
        => (e.Value as string[] ?? Array.Empty<string>()).ToList();

    // FIX 1: Added handler for new Customer listbox
    private void HandleCustomerListBoxSelection(ChangeEventArgs e) => selectedCustomerListboxItems = GetSelectedItemsFromChange(e);
    private void HandleReceivedFromListBoxSelection(ChangeEventArgs e) => selectedReceivedFromListboxItems = GetSelectedItemsFromChange(e);
    private void HandleSEListBoxSelection(ChangeEventArgs e) => selectedSEListboxItems = GetSelectedItemsFromChange(e);
    private void HandleEnqTypeListBoxSelection(ChangeEventArgs e) => selectedEnqTypeListboxItems = GetSelectedItemsFromChange(e);
    private void HandleEnqForListBoxSelection(ChangeEventArgs e) => selectedEnqForListboxItems = GetSelectedItemsFromChange(e);
    private void HandleRoleListBoxSelection(ChangeEventArgs e) => selectedRoleListboxItems = GetSelectedItemsFromChange(e);
    private void HandleCommonMailListBoxSelection(ChangeEventArgs e) => selectedCommonMailListboxItems = GetSelectedItemsFromChange(e);
    private void HandleCCMailListBoxSelection(ChangeEventArgs e) => selectedCCMailListboxItems = GetSelectedItemsFromChange(e);

    // FIX 1: Added methods for Customer listbox
    private void AddCustomerToListBox()
    {
        if (!string.IsNullOrWhiteSpace(selectedCustomerInput) && !customerListBox.Contains(selectedCustomerInput.Trim(), StringComparer.OrdinalIgnoreCase))
        {
            customerListBox.Add(selectedCustomerInput.Trim());
            inputErrors.Remove("CustomerName");
            selectedCustomerInput = null;
        }
        UpdateReceivedFromList(); // === FIX 3: Refresh contact dropdown ===
        StateHasChanged();
    }

    // === START: FINAL CORRECTION 1 ===
    private void RemoveCustomerFromListBox()
    {
        // Get the list of companies being removed
        var companiesRemoved = selectedCustomerListboxItems.ToList();

        foreach (var item in companiesRemoved)
        {
            customerListBox.Remove(item);
        }

        // Now, remove all contacts associated with these removed companies
        foreach (var companyName in companiesRemoved)
        {
            receivedContactListBox.RemoveAll(contactString =>
            {
                var parts = contactString.Split(CONTACT_DELIMITER);
                if (parts.Length > 1)
                {
                    return parts[1].Equals(companyName, StringComparison.OrdinalIgnoreCase);
                }
                return false;
            });
        }

        selectedCustomerListboxItems.Clear();
        UpdateReceivedFromList(); // Refresh contact dropdown
        StateHasChanged();
    }
    // === END: FINAL CORRECTION 1 ===


    // FIX 1: Removed validation check
    private void AddSelectedContactToListBox()
    {
        inputErrors.Remove("ReceivedFrom");

        if (!string.IsNullOrWhiteSpace(selectedReceivedContact))
        {
            if (!receivedContactListBox.Contains(selectedReceivedContact, StringComparer.OrdinalIgnoreCase))
            {
                receivedContactListBox.Add(selectedReceivedContact);
            }
            selectedReceivedContact = null;
        }
        StateHasChanged();
    }

    // === START: FINAL CORRECTION 2 ===
    private void RemoveSelectedContactFromListBox()
    {
        // 1. Find which companies are affected by this removal
        var affectedCompanies = selectedReceivedFromListboxItems
            .Select(s => s.Split(CONTACT_DELIMITER)[1])
            .Distinct()
            .ToList();

        // 2. Perform the removal
        foreach (var itemKey in selectedReceivedFromListboxItems.ToList())
        {
            receivedContactListBox.Remove(itemKey);
        }

        // 3. Get all companies *still* in the contact list
        var companiesStillInContactList = receivedContactListBox
            .Select(s => s.Split(CONTACT_DELIMITER)[1])
            .ToHashSet(StringComparer.OrdinalIgnoreCase);

        // 4. Find which of the affected companies are no longer in the list
        var companiesToRemoveFromCustomerList = affectedCompanies
            .Where(company => !companiesStillInContactList.Contains(company))
            .ToList();

        // 5. Remove those companies from the customer listbox
        if (companiesToRemoveFromCustomerList.Any())
        {
            customerListBox.RemoveAll(customer => companiesToRemoveFromCustomerList.Contains(customer));

            // 6. Refresh the contact dropdown, as the customer list has changed
            UpdateReceivedFromList();
        }

        selectedReceivedFromListboxItems.Clear();
        StateHasChanged();
    }
    // === END: FINAL CORRECTION 2 ===

    private void AddToListBoxenqtype()
    {
        if (!string.IsNullOrWhiteSpace(selectedenqtype) && !enqtypelistbox.Contains(selectedenqtype.Trim(), StringComparer.OrdinalIgnoreCase))
        {
            enqtypelistbox.Add(selectedenqtype.Trim());
            inputErrors.Remove("Enquirytype");
            selectedenqtype = null;
        }
        StateHasChanged();
    }
    private void RemoveFromListBoxenqtype()
    {
        foreach (var item in selectedEnqTypeListboxItems.ToList())
        {
            enqtypelistbox.Remove(item);
        }
        selectedEnqTypeListboxItems.Clear();
        StateHasChanged();
    }
    private void AddToListBoxenqfor()
    {
        if (ValidateControlledInput(selectedenqfor, enquiryfor, "Enquiryfor"))
        {
            if (!string.IsNullOrWhiteSpace(selectedenqfor) && !enqforlistbox.Contains(selectedenqfor.Trim(), StringComparer.OrdinalIgnoreCase))
            {
                enqforlistbox.Add(selectedenqfor.Trim());
                inputErrors.Remove("Enquiryfor");
                selectedenqfor = null;
            }
        }
        StateHasChanged();
    }
    private void RemoveFromListBoxenqfor()
    {
        foreach (var item in selectedEnqForListboxItems.ToList())
        {
            enqforlistbox.Remove(item);
        }
        selectedEnqForListboxItems.Clear();
        StateHasChanged();
    }

    private void AddSEToListBoxToselectedSE()
    {
        if (ValidateControlledInput(selectedSE, concernedSEs, "ConcernedSE"))
        {
            if (!string.IsNullOrWhiteSpace(selectedSE) && !seListBox.Contains(selectedSE.Trim(), StringComparer.OrdinalIgnoreCase))
            {
                seListBox.Add(selectedSE.Trim());
                inputErrors.Remove("ConcernedSE");
                selectedSE = null;
            }
        }
        StateHasChanged();
    }
    private void RemoveSEFromListBoxselectedSE()
    {
        foreach (var item in selectedSEListboxItems.ToList())
        {
            seListBox.Remove(item);
        }
        selectedSEListboxItems.Clear();
        StateHasChanged();
    }
    private void AddCommonMailToListBox()
    {
        if (!string.IsNullOrWhiteSpace(newCommonMailEntry) && !newEnquiryForItem.CommonMailIds.Contains(newCommonMailEntry.Trim()))
        {
            newEnquiryForItem.CommonMailIds.Add(newCommonMailEntry.Trim());
            newCommonMailEntry = string.Empty;
        }
        StateHasChanged();
    }
    private void RemoveCommonMailFromListBox()
    {
        foreach (var item in selectedCommonMailListboxItems.ToList())
        {
            newEnquiryForItem.CommonMailIds.Remove(item);
        }
        selectedCommonMailListboxItems.Clear();
        StateHasChanged();
    }
    private void AddCCMailToListBox()
    {
        if (!string.IsNullOrWhiteSpace(newCCMailEntry) && !newEnquiryForItem.CCMailIds.Contains(newCCMailEntry.Trim()))
        {
            newEnquiryForItem.CCMailIds.Add(newCCMailEntry.Trim());
            newCCMailEntry = string.Empty;
        }
        StateHasChanged();
    }
    private void RemoveCCMailFromListBox()
    {
        foreach (var item in selectedCCMailListboxItems.ToList())
        {
            newEnquiryForItem.CCMailIds.Remove(item);
        }
        selectedCCMailListboxItems.Clear();
        StateHasChanged();
    }
    private void AddRoleToListBox()
    {
        if (!string.IsNullOrWhiteSpace(newRoleEntry) && !newUserModel.Roles.Contains(newRoleEntry.Trim()))
        {
            newUserModel.Roles.Add(newRoleEntry.Trim());
            newRoleEntry = string.Empty;
        }
        StateHasChanged();
    }
    private void RemoveRoleFromListBox()
    {
        foreach (var item in selectedRoleListboxItems.ToList())
        {
            newUserModel.Roles.Remove(item);
        }
        selectedRoleListboxItems.Clear();
        StateHasChanged();
    }

    // ---------- MODAL TOGGLES / EDITS ----------

    private void ToggleNewCustomerInput()
    {
        modalMode = "Add";
        newCustomerCompany = new CustomerCompanyModel();
        showCustomerModal = true;
        StateHasChanged();
    }
    private void CloseCustomerModal()
    {
        showCustomerModal = false;
        newCustomerCompanyFromContact = null;
        StateHasChanged();
    }

    private void ToggleNewReceivedFromInput()
    {
        // FIX 1: Removed check against single customer
        // if (string.IsNullOrWhiteSpace(selectedCustomerCompany)) ...

        modalMode = "Add";
        modalContactPerson = new ContactPersonModel()
        {
            Category = "Contractor",
            // We can't default a company name anymore
            // CompanyName = selectedCustomerCompany
        };
        contactToEdit = null;
        showContactModal = true;
        StateHasChanged();
    }
    private void CloseContactModal()
    {
        showContactModal = false; StateHasChanged();
    }
    private void OnCancelContact()
    {
        showContactModal = false; contactToEdit = null; modalContactPerson = new ContactPersonModel(); StateHasChanged();
    }

    private void StartEditContact()
    {
        string? key = selectedReceivedFromListboxItems.FirstOrDefault() ?? selectedReceivedContact;
        if (string.IsNullOrWhiteSpace(key)) return;

        var parts = key.Split(CONTACT_DELIMITER);
        if (parts.Length == 2)
        {
            string contactName = parts[0].Trim();
            string companyName = parts[1].Trim();

            contactToEdit = storedContacts.FirstOrDefault(c =>
                c.ContactName.Equals(contactName, StringComparison.OrdinalIgnoreCase) &&
                c.CompanyName.Equals(companyName, StringComparison.OrdinalIgnoreCase));

            if (contactToEdit != null)
            {
                modalContactPerson = ContactPersonModel.Clone(contactToEdit);
                modalMode = "Edit";
                showContactModal = true;
            }
            else
            {
                JSRuntime.InvokeVoidAsync("alert", "Error: Contact details not found for editing in master list.");
            }
        }
        else
        {
            JSRuntime.InvokeVoidAsync("alert", "Error: Invalid contact selection format.");
        }
        StateHasChanged();
    }

    private void ToggleNewUserModal()
    {
        modalMode = "Add";
        newUserModel = new UserModel();
        newRoleEntry = string.Empty;
        showUserModal = true;
        StateHasChanged();
    }
    private void CloseUserModal()
    {
        showUserModal = false; StateHasChanged();
    }
    private void ToggleNewEnquiryForModal()
    {
        modalMode = "Add";
        newEnquiryForItem = new EnquiryForItemModel();
        newCommonMailEntry = string.Empty;
        newCCMailEntry = string.Empty;
        showEnqForModal = true;
        StateHasChanged();
    }
    private void CloseEnqForModal()
    {
        showEnqForModal = false; StateHasChanged();
    }

    private void StartEditCompany()
    {
        // FIX 1: Logic updated to check input field or listbox
        string companyName = selectedCustomerInput ?? selectedCustomerListboxItems.FirstOrDefault() ?? string.Empty;

        if (string.IsNullOrWhiteSpace(companyName))
        {
            companyName = enquiryModel.ClientName ?? enquiryModel.ConsultantName ?? string.Empty;
        }

        companyToEdit = storedCustomers.FirstOrDefault(c => c.CompanyName.Equals(companyName, StringComparison.OrdinalIgnoreCase));
        if (companyToEdit != null)
        {
            newCustomerCompany = CustomerCompanyModel.Clone(companyToEdit);
            modalMode = "Edit";
            showCustomerModal = true;
        }
        else if (!string.IsNullOrWhiteSpace(companyName))
        {
            JSRuntime.InvokeVoidAsync("alert", $"Cannot edit '{companyName}'. Company details not found in master list.");
        }
        StateHasChanged();
    }
    private void StartEditUser()
    {
        userToEdit = storedUsers.FirstOrDefault(u => u.FullName.Equals(selectedSE, StringComparison.OrdinalIgnoreCase));
        if (userToEdit != null)
        {
            newUserModel = UserModel.Clone(userToEdit);
            modalMode = "Edit";
            newRoleEntry = string.Empty;
            showUserModal = true;
        }
        StateHasChanged();
    }
    private void StartEditEnquiryFor()
    {
        enqItemToEdit = storedEnqItems.FirstOrDefault(i => i.ItemName.Equals(selectedenqfor, StringComparison.OrdinalIgnoreCase));
        if (enqItemToEdit != null)
        {
            newEnquiryForItem = EnquiryForItemModel.Clone(enqItemToEdit);
            modalMode = "Edit";
            newCommonMailEntry = string.Empty;
            newCCMailEntry = string.Empty;
            showEnqForModal = true;
        }
        StateHasChanged();
    }

    // ---------- MODAL SUBMISSIONS ----------

    private async void HandleNewCompanySubmit()
    {
        if (modalMode == "Add")
        {
            storedCustomers.Add(newCustomerCompany);
        }
        else if (modalMode == "Edit" && companyToEdit != null)
        {
            var index = storedCustomers.IndexOf(companyToEdit);
            if (index != -1) storedCustomers[index] = newCustomerCompany;
        }
        else if (newCustomerCompanyFromContact != null)
        {
            var existingCompany = storedCustomers.FirstOrDefault(c => c.CompanyName.Equals(newCustomerCompany.CompanyName, StringComparison.OrdinalIgnoreCase));
            if (existingCompany != null)
            {
                var index = storedCustomers.IndexOf(existingCompany);
                if (index != -1) storedCustomers[index] = newCustomerCompany;
            }
            else
            {
                storedCustomers.Add(newCustomerCompany);
            }
        }


        UpdateAllListsFromStorage();

        if (newCustomerCompany.Status == "Active")
        {
            if (newCustomerCompany.Category == "Contractor")
            {
                // FIX 1: Add to listbox instead of setting single variable
                if (!customerListBox.Contains(newCustomerCompany.CompanyName))
                {
                    customerListBox.Add(newCustomerCompany.CompanyName);
                }
                selectedCustomerInput = null; // Clear dropdown
                UpdateReceivedFromList(); // === FIX 3: Refresh contact dropdown ===
            }
            else if (newCustomerCompany.Category == "Client") enquiryModel.ClientName = newCustomerCompany.CompanyName;
            else if (newCustomerCompany.Category == "Consultant") enquiryModel.ConsultantName = newCustomerCompany.CompanyName;
        }

        await JSRuntime.InvokeVoidAsync("alert", $"Company details {(modalMode == "Edit" ? "updated" : "added")} successfully!");


        showCustomerModal = false;
        newCustomerCompany = new CustomerCompanyModel();
        companyToEdit = null;
        newCustomerCompanyFromContact = null;
        modalMode = "Add";
        StateHasChanged();
    }

    private async void HandleNewContactSubmit()
    {
        bool newCompanyCreated = false;

        bool companyExists = storedCustomers.Any(c =>
            c.CompanyName.Equals(modalContactPerson.CompanyName, StringComparison.OrdinalIgnoreCase) &&
            c.Category == "Contractor" && c.Status == "Active");

        if (modalMode == "Add")
        {
            if (!companyExists)
            {
                newCustomerCompanyFromContact = CustomerCompanyModel.FromContact(modalContactPerson);
                newCompanyCreated = true;
            }
            storedContacts.Add(modalContactPerson);
        }
        else if (modalMode == "Edit" && contactToEdit != null)
        {
            var index = storedContacts.IndexOf(contactToEdit);
            if (index != -1) { storedContacts[index] = modalContactPerson; }
            contactToEdit = modalContactPerson;

            if (!companyExists)
            {
                newCustomerCompanyFromContact = CustomerCompanyModel.FromContact(modalContactPerson);
                newCompanyCreated = true;
            }
        }

        UpdateAllListsFromStorage();

        if (modalContactPerson.Category == "Contractor")
        {
            string newContactKey = $"{modalContactPerson.ContactName}{CONTACT_DELIMITER}{modalContactPerson.CompanyName}";

            // FIX 1: Simplified logic - just add the new contact to the list
            if (!receivedContactListBox.Contains(newContactKey))
            {
                receivedContactListBox.Add(newContactKey);
            }
            selectedReceivedContact = null;
        }

        showContactModal = false;
        modalContactPerson = new ContactPersonModel();
        contactToEdit = null;
        modalMode = "Add";
        StateHasChanged();

        if (newCompanyCreated && newCustomerCompanyFromContact != null)
        {
            await JSRuntime.InvokeVoidAsync("alert", "Please complete the remaining Company/Client/Consultant details.");
            newCustomerCompany = newCustomerCompanyFromContact;
            modalMode = "Add";
            showCustomerModal = true;
        }
        else
        {
            await JSRuntime.InvokeVoidAsync("alert", "Contact details added successfully!");
        }
    }

    private void HandleNewUserSubmit()
    {
        if (modalMode == "Add") storedUsers.Add(newUserModel);
        else if (modalMode == "Edit" && userToEdit != null)
        {
            var index = storedUsers.IndexOf(userToEdit);
            if (index != -1) storedUsers[index] = newUserModel;
        }

        UpdateAllListsFromStorage();
        if (newUserModel.Status == "Active") selectedSE = newUserModel.FullName;

        showUserModal = false;
        newUserModel = new UserModel();
        userToEdit = null;
        StateHasChanged();
    }

    private void HandleNewEnquiryForItemSubmit()
    {
        if (modalMode == "Add") storedEnqItems.Add(newEnquiryForItem);
        else if (modalMode == "Edit" && enqItemToEdit != null)
        {
            var index = storedEnqItems.IndexOf(enqItemToEdit);
            if (index != -1) storedEnqItems[index] = newEnquiryForItem;
        }

        UpdateAllListsFromStorage();
        if (newEnquiryForItem.Status == "Active") selectedenqfor = newEnquiryForItem.ItemName;

        showEnqForModal = false;
        newEnquiryForItem = new EnquiryForItemModel();
        enqItemToEdit = null;
        StateHasChanged();
    }

    // ---------- VALIDATION / SUBMIT (UPDATED) ----------

    private void ClearValidationError(string fieldName)
    {
        if (inputErrors.ContainsKey(fieldName))
        {
            inputErrors.Remove(fieldName);
        }
    }

    private async Task HandleTextAreaKeyPress(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" && e.CtrlKey)
        {
            if (activeTab == "New")
            {
                await HandleMainFormSubmit();
            }
            else if (activeTab == "Modify")
            {
                HandleModifyFormSubmit();
            }
        }
    }

    private bool ValidateControlledInput(string? inputValue, List<string> masterList, string errorKey)
    {
        inputErrors.Remove(errorKey);
        if (string.IsNullOrWhiteSpace(inputValue)) return true;
        if (!masterList.Any(n => n.Equals(inputValue.Trim(), StringComparison.OrdinalIgnoreCase)))
        {
            inputErrors[errorKey] = NO_DATA_FOUND; return false;
        }
        return true;
    }

    private async Task HandleMainFormSubmit()
    {
        HandleMainFormValidationOnly(out bool isValid);
        if (!isValid) return;

        string requestNo = GenerateRequestNumber();
        var snap = BuildSnapshotFromForm(requestNo);
        enquiriesDb[requestNo] = snap;

        await JSRuntime.InvokeVoidAsync("alert", $"Enquiry submitted successfully! Request No: {requestNo}");
        ResetFormState();
    }

    private EnquirySnapshot BuildSnapshotFromForm(string requestNo) => new()
    {
        RequestNo = requestNo,
        SourceOfInfo = enquiryModel.SourceOfInfo,
        EnquiryDate = enquiryModel.EnquiryDate,
        DueOn = enquiryModel.DueOn,
        SiteVisitDate = enquiryModel.SiteVisitDate,
        ProjectName = enquiryModel.ProjectName,
        ClientName = enquiryModel.ClientName,
        ConsultantName = enquiryModel.ConsultantName,
        DetailsOfEnquiry = enquiryModel.DetailsOfEnquiry,
        DocumentsReceived = enquiryModel.DocumentsReceived,
        hardcopy = enquiryModel.hardcopy,
        drawing = enquiryModel.drawing,
        dvd = enquiryModel.dvd,
        spec = enquiryModel.spec,
        eqpschedule = enquiryModel.eqpschedule,
        Remark = enquiryModel.Remark,
        AutoAck = enquiryModel.AutoAck,
        ceosign = enquiryModel.ceosign,
        SelectedEnquiryTypes = enqtypelistbox.ToList(),
        SelectedEnquiryFor = enqforlistbox.ToList(),
        SelectedCustomers = customerListBox.ToList(), // FIX 1: Save the listbox
        SelectedReceivedFroms = receivedContactListBox.ToList(),
        SelectedConcernedSEs = seListBox.ToList(),
        Status = enquiryModel.Status
    };

    private void PopulateFormFromSnapshot(EnquirySnapshot s)
    {
        enquiryModel.SourceOfInfo = s.SourceOfInfo;
        enquiryModel.EnquiryDate = s.EnquiryDate;
        enquiryModel.DueOn = s.DueOn;
        enquiryModel.SiteVisitDate = s.SiteVisitDate;
        enquiryModel.ProjectName = s.ProjectName;
        enquiryModel.ClientName = s.ClientName;
        enquiryModel.ConsultantName = s.ConsultantName;
        enquiryModel.DetailsOfEnquiry = s.DetailsOfEnquiry;
        enquiryModel.DocumentsReceived = s.DocumentsReceived;
        enquiryModel.hardcopy = s.hardcopy;
        enquiryModel.drawing = s.drawing;
        enquiryModel.dvd = s.dvd;
        enquiryModel.spec = s.spec;
        enquiryModel.eqpschedule = s.eqpschedule;
        enquiryModel.Remark = s.Remark;
        enquiryModel.AutoAck = s.AutoAck;
        enquiryModel.ceosign = s.ceosign;
        enquiryModel.Status = s.Status;

        enqtypelistbox = s.SelectedEnquiryTypes.ToList();
        enqforlistbox = s.SelectedEnquiryFor.ToList();

        customerListBox = s.SelectedCustomers.ToList(); // FIX 1: Populate customer listbox
        selectedCustomerInput = null; // Clear dropdown

        receivedContactListBox = s.SelectedReceivedFroms.ToList();
        seListBox = s.SelectedConcernedSEs.ToList();

        UpdateReceivedFromList(); // === FIX 3: This will now correctly filter the contact dropdown ===
        StateHasChanged();
    }

    private void HandleMainFormValidationOnly(out bool isValid)
    {
        inputErrors.Clear();
        isValid = true;

        isValid &= ValidateControlledInput(enquiryModel.ClientName, clientNames, "ClientName");
        isValid &= ValidateControlledInput(enquiryModel.ConsultantName, consultantNames, "ConsultantName");

        if (activeTab == "Modify")
            isValid &= ValidateRequiredField(enquiryModel.Status, "Status", "Status is required.");

        isValid &= ValidateRequiredField(enquiryModel.SourceOfInfo, "SourceOfInfo", "Source is required.");
        isValid &= ValidateRequiredDateField(enquiryModel.EnquiryDate, "EnquiryDate", "Enquiry Date is required.");
        isValid &= ValidateRequiredDateField(enquiryModel.DueOn, "DueOn", "Due Date is required.");
        if (enquiryModel.EnquiryDate.HasValue && enquiryModel.DueOn.HasValue)
            isValid &= ValidateDueDate(enquiryModel.DueOn, enquiryModel.EnquiryDate, "DueOn");

        isValid &= ValidateRequiredField(enquiryModel.DetailsOfEnquiry, "DetailsOfEnquiry", "Enquiry details are required.");
        isValid &= ValidateRequiredListbox(enqtypelistbox, "Enquirytype", "At least one Enquiry Type is required.");
        isValid &= ValidateRequiredListbox(enqforlistbox, "Enquiryfor", "At least one Enquiry For item is required.");
        isValid &= ValidateRequiredListbox(seListBox, "ConcernedSE", "At least one 'Concerned SE' is required.");

        isValid &= ValidateRequiredListbox(customerListBox, "CustomerName", "At least one Customer Company is required."); // FIX 1: Validate listbox
        isValid &= ValidateRequiredListbox(receivedContactListBox, "ReceivedFrom", "At least one 'Received From' contact is required.");

        isValid &= ValidateRequiredField(enquiryModel.ProjectName, "ProjectName", "Project Name is required.");
        isValid &= ValidateRequiredField(enquiryModel.ClientName, "ClientName", "Client Name is required.");

        if (!isValid)
        {
            StateHasChanged();
            JSRuntime.InvokeVoidAsync("alert", "Validation failed. Please correct the fields with red messages.");
        }
    }

    private bool ValidateRequiredField(string? value, string key, string message)
    {
        if (string.IsNullOrWhiteSpace(value) && !inputErrors.ContainsKey(key))
        {
            inputErrors[key] = message; return false;
        }
        return true;
    }
    private bool ValidateRequiredListbox(List<string> list, string key, string message)
    {
        if (list.Count == 0) { inputErrors[key] = message; return false; }
        return true;
    }
    private bool ValidateRequiredDateField(DateTime? date, string key, string message)
    {
        if (!date.HasValue || date.Value == DateTime.MinValue) { inputErrors[key] = message; return false; }
        return true;
    }
    private bool ValidateDueDate(DateTime? dueDate, DateTime? enquiryDate, string key)
    {
        if (!dueDate.HasValue || !enquiryDate.HasValue) return true;
        if (dueDate.Value.Date < enquiryDate.Value.Date)
        {
            inputErrors[key] = "Due Date cannot be before the Enquiry Date."; return false;
        }
        return true;
    }

    private string GenerateRequestNumber()
    {
        string year = DateTime.Now.Year.ToString();
        string month = DateTime.Now.Month.ToString("00");
        int currentCount = enquiriesDb.Count + 1;
        return $"EYS/{year}/{month}/{currentCount:000}";
    }

    private void ResetFormState()
    {
        enquiryModel = new EnquiryModel();
        enquiryModel.EnquiryDate = DateTime.Now.Date;
        enquiryModel.Status = "Enquiry"; // FIX 3: Default status updated

        selectedCustomerInput = null; // FIX 1
        selectedReceivedContact = null;
        selectedSE = null;
        selectedenqtype = null;
        selectedenqfor = null;

        customerListBox.Clear(); // FIX 1
        receivedContactListBox.Clear();
        seListBox.Clear();
        enqtypelistbox.Clear();
        enqforlistbox.Clear();
        filteredReceivedFroms.Clear();

        selectedCustomerListboxItems.Clear(); // FIX 1
        selectedReceivedFromListboxItems.Clear();
        selectedSEListboxItems.Clear();
        selectedEnqTypeListboxItems.Clear();
        selectedEnqForListboxItems.Clear();
        inputErrors.Clear();

        UpdateReceivedFromList();
        StateHasChanged();
    }

    // ---------- MODIFY FLOW ----------
    private string modifyRequestNo = string.Empty;
    private EnquirySnapshot? modifyLoadedSnapshot = null;

    private async Task LoadForModify()
    {
        inputErrors.Clear();
        modifyLoadedSnapshot = null;
        ResetFormState();

        var key = (modifyRequestNo ?? string.Empty).Trim();
        if (string.IsNullOrWhiteSpace(key))
        {
            await JSRuntime.InvokeVoidAsync("alert", "Please enter a Request No.");
            return;
        }

        if (!enquiriesDb.TryGetValue(key, out var snap))
        {
            await JSRuntime.InvokeVoidAsync("alert", $"Request No '{key}' not found.");
            return;
        }

        modifyLoadedSnapshot = snap;
        PopulateFormFromSnapshot(snap);
    }

    private void ClearModify()
    {
        modifyRequestNo = string.Empty;
        modifyLoadedSnapshot = null;
        isModifyingClosedRequest = false; // === FIX 1: Reset "closed" flag ===
        ResetFormState();
    }

    // === FIX 1: UPDATED to handle warning popup ===
    private async void HandleModifyFormSubmit()
    {
        if (modifyLoadedSnapshot is null || string.IsNullOrWhiteSpace(modifyRequestNo))
        {
            await JSRuntime.InvokeVoidAsync("alert", "Nothing loaded to modify.");
            return;
        }

        HandleMainFormValidationOnly(out bool ok);
        if (!ok) return;

        // Check if this is a closed request
        if (isModifyingClosedRequest)
        {
            // Don't save yet. Show the modal.
            userAgreesToSaveClosed = false; // Reset checkbox
            showClosedWarningModal = true;
            StateHasChanged();
            return; // Stop execution until modal is handled
        }

        // This part only runs if it's NOT a closed request
        await SaveModifyChanges();
    }

    // === FIX 1: NEW method to contain the actual save logic ===
    private async Task SaveModifyChanges()
    {
        if (modifyLoadedSnapshot is null || string.IsNullOrWhiteSpace(modifyRequestNo)) return;

        var snap = BuildSnapshotFromForm(modifyRequestNo);
        enquiriesDb[modifyRequestNo] = snap;
        modifyLoadedSnapshot = snap;

        await JSRuntime.InvokeVoidAsync("alert", $"Changes saved for {modifyRequestNo}");

        ClearModify(); // This also resets isModifyingClosedRequest
        showClosedWarningModal = false; // Ensure modal is hidden
        userAgreesToSaveClosed = false; // Reset checkbox
    }

    // === FIX 1: NEW method to handle the modal's save button click ===
    private async void HandleClosedWarningSave()
    {
        if (userAgreesToSaveClosed)
        {
            await SaveModifyChanges();
        }
    }


    // ---------- SEARCH (UPDATED) ----------
    private string searchText = string.Empty;
    private DateTime? searchFromDate = null;
    private DateTime? searchToDate = null;
    private List<EnquirySnapshot> searchResults = new();

    private void RunSearch()
    {
        IEnumerable<EnquirySnapshot> q = enquiriesDb.Values.OrderByDescending(v => v.EnquiryDate ?? DateTime.MinValue);

        var s = (searchText ?? string.Empty).Trim();

        if (string.IsNullOrWhiteSpace(s))
        {
            if (searchCategory != "All" && !string.IsNullOrWhiteSpace(searchCategoryValue))
            {
                q = ApplyCategoryFilter(q, searchCategory, searchCategoryValue);
            }

            if (searchFromDate.HasValue)
                q = q.Where(v => (v.EnquiryDate ?? DateTime.MinValue).Date >= searchFromDate.Value.Date);
            if (searchToDate.HasValue)
                q = q.Where(v => (v.EnquiryDate ?? DateTime.MinValue).Date <= searchToDate.Value.Date);

            searchResults = q.Take(50).ToList();
        }
        else
        {
            s = s.ToLowerInvariant();
            q = q.Where(v =>
                    (v.RequestNo?.ToLowerInvariant().Contains(s) ?? false) ||
                    (v.ClientName?.ToLowerInvariant().Contains(s) ?? false) ||
                    (v.ProjectName?.ToLowerInvariant().Contains(s) ?? false) ||
                    (v.SourceOfInfo?.ToLowerInvariant().Contains(s) ?? false) ||
                    v.SelectedCustomers.Any(cust => cust.ToLowerInvariant().Contains(s)) ||
                    v.SelectedConcernedSEs.Any(x => x.ToLowerInvariant().Contains(s)));

            if (searchCategory != "All" && !string.IsNullOrWhiteSpace(searchCategoryValue))
            {
                q = ApplyCategoryFilter(q, searchCategory, searchCategoryValue);
            }

            if (searchFromDate.HasValue)
                q = q.Where(v => (v.EnquiryDate ?? DateTime.MinValue).Date >= searchFromDate.Value.Date);
            if (searchToDate.HasValue)
                q = q.Where(v => (v.EnquiryDate ?? DateTime.MinValue).Date <= searchToDate.Value.Date);

            searchResults = q.ToList();
        }

        StateHasChanged();
    }

    private IEnumerable<EnquirySnapshot> ApplyCategoryFilter(IEnumerable<EnquirySnapshot> query, string category, string value)
    {
        if (string.IsNullOrWhiteSpace(value))
        {
            return query;
        }
        var val = value.Trim();

        return category switch
        {
            "SourceOfInfo" => query.Where(v => v.SourceOfInfo.Equals(val, StringComparison.OrdinalIgnoreCase)),
            "EnquiryType" => query.Where(v => v.SelectedEnquiryTypes.Any(et => et.Equals(val, StringComparison.OrdinalIgnoreCase))),
            "EnquiryFor" => query.Where(v => v.SelectedEnquiryFor.Any(ef => ef.Equals(val, StringComparison.OrdinalIgnoreCase))),
            "Status" => query.Where(v => v.Status.Equals(val, StringComparison.OrdinalIgnoreCase)),
            _ => query,
        };
    }

    private void ClearSearch()
    {
        searchText = string.Empty;
        searchFromDate = null;
        searchToDate = null;
        searchCategory = "All";
        searchCategoryValue = string.Empty;
        searchResults.Clear();
        RunSearch();
    }

    // === FIX 1: UPDATED signature to accept "isClosed" flag ===
    private void OpenInModify(string reqNo, bool isClosed = false)
    {
        isModifyingClosedRequest = isClosed; // Store the flag
        modifyRequestNo = reqNo;
        SwitchTab("Modify");
        _ = LoadForModify();
    }
}